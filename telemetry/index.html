<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Telemetry | AI Hub v2.0 — The Confidence Engine</title>

    <meta name="description" content="Telemetry — Track recruiting metrics, identify bottlenecks, and measure AI impact across the pipeline.">
    <meta name="author" content="AI Hub v2.0">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Design System -->
    <link rel="stylesheet" href="../shared/theme.css">
    <link rel="stylesheet" href="../shared/sidebar.css">
    <link rel="stylesheet" href="../shared/v2-buttons.css">
    <link rel="stylesheet" href="../shared/v2-cards.css">

    <style>
        .tel-header { margin-bottom: var(--space-8); }
        .tel-header__label { font-size: var(--font-sm); color: var(--text-muted); font-weight: var(--weight-medium); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: var(--space-2); }
        .tel-header__title { font-size: var(--font-4xl); font-weight: var(--weight-bold); color: var(--text-primary); letter-spacing: -0.02em; }
        .tel-header__title span { color: var(--accent-cyan); }
        .tel-header__subtitle { font-size: var(--font-base); color: var(--text-secondary); margin-top: var(--space-2); max-width: 640px; line-height: 1.6; }

        /* Tabs */
        .tel-tabs { display: flex; gap: var(--space-1); border-bottom: 1px solid var(--border-subtle); margin-bottom: var(--space-8); }
        .tel-tab { padding: var(--space-3) var(--space-5); font-size: var(--font-sm); font-weight: var(--weight-medium); color: var(--text-muted); background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; transition: all var(--transition-fast); font-family: inherit; }
        .tel-tab:hover { color: var(--text-secondary); }
        .tel-tab.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeInUp 0.3s ease both; }

        /* Entry Form */
        .entry-form { max-width: 680px; }
        .form-section { margin-bottom: var(--space-8); }
        .form-section__title { font-size: var(--font-base); font-weight: var(--weight-semibold); color: var(--text-primary); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2); }
        .form-section__title svg { width: 16px; height: 16px; color: var(--accent-cyan); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); }
        .form-group { display: flex; flex-direction: column; gap: var(--space-2); }
        .form-group--full { grid-column: 1 / -1; }
        .form-label { font-size: var(--font-sm); color: var(--text-secondary); font-weight: var(--weight-medium); }
        .form-hint { font-size: var(--font-xs); color: var(--text-muted); }
        .form-input, .form-select, .form-textarea { padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-size: var(--font-sm); font-family: inherit; outline: none; transition: border-color var(--transition-fast); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent-cyan); }
        .form-input::placeholder, .form-textarea::placeholder { color: var(--text-muted); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-select { cursor: pointer; }
        .form-row { display: flex; gap: var(--space-3); align-items: flex-end; }
        .form-actions { display: flex; gap: var(--space-3); margin-top: var(--space-6); }
        .btn-primary { padding: 10px 24px; background: var(--accent-cyan); color: var(--bg-primary); border: none; border-radius: var(--radius-md); font-size: var(--font-sm); font-weight: var(--weight-semibold); cursor: pointer; font-family: inherit; transition: opacity var(--transition-fast); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { padding: 10px 24px; background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); font-size: var(--font-sm); font-weight: var(--weight-medium); cursor: pointer; font-family: inherit; transition: all var(--transition-fast); }
        .btn-secondary:hover { color: var(--text-primary); border-color: var(--border-default); }

        /* Dashboard */
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-8); }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: var(--space-5); text-align: center; }
        .stat-card__value { font-size: var(--font-3xl); font-weight: var(--weight-bold); color: var(--text-primary); font-family: var(--font-mono); }
        .stat-card__label { font-size: var(--font-xs); color: var(--text-muted); margin-top: var(--space-1); text-transform: uppercase; letter-spacing: 0.06em; }
        .stat-card__trend { font-size: var(--font-xs); margin-top: var(--space-2); font-weight: var(--weight-medium); }
        .stat-card__trend--up { color: var(--signal-strong); }
        .stat-card__trend--down { color: var(--signal-risk); }
        .stat-card__trend--flat { color: var(--text-muted); }

        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6); margin-bottom: var(--space-8); }
        .chart-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: var(--space-5); }
        .chart-card__title { font-size: var(--font-sm); font-weight: var(--weight-semibold); color: var(--text-primary); margin-bottom: var(--space-4); }
        .chart-card canvas { width: 100% !important; max-height: 280px; }

        /* Autopsy */
        .autopsy-section { max-width: 720px; }
        .autopsy-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: var(--space-6); margin-bottom: var(--space-6); }
        .autopsy-card__title { font-size: var(--font-base); font-weight: var(--weight-semibold); color: var(--text-primary); margin-bottom: var(--space-4); }

        /* Data Log */
        .data-log { margin-top: var(--space-8); }
        .data-log__title { font-size: var(--font-sm); font-weight: var(--weight-semibold); color: var(--text-primary); margin-bottom: var(--space-4); display: flex; align-items: center; justify-content: space-between; }
        .log-table { width: 100%; border-collapse: collapse; }
        .log-table th, .log-table td { padding: var(--space-2) var(--space-3); text-align: left; font-size: var(--font-sm); border-bottom: 1px solid var(--border-subtle); }
        .log-table th { color: var(--text-muted); font-weight: var(--weight-medium); font-size: var(--font-xs); text-transform: uppercase; letter-spacing: 0.04em; }
        .log-table td { color: var(--text-secondary); }
        .log-table tr:last-child td { border-bottom: none; }
        .log-empty { text-align: center; padding: var(--space-8); color: var(--text-muted); font-size: var(--font-sm); }

        /* Period selector */
        .period-select { display: flex; gap: var(--space-2); margin-bottom: var(--space-6); }
        .period-btn { padding: 6px 14px; font-size: var(--font-xs); font-weight: var(--weight-medium); color: var(--text-muted); background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-full); cursor: pointer; font-family: inherit; transition: all var(--transition-fast); }
        .period-btn:hover { color: var(--text-secondary); border-color: var(--border-default); }
        .period-btn.active { color: var(--accent-cyan); border-color: var(--accent-cyan); background: rgba(0,229,255,0.08); }

        /* Team Intel */
        .team-intel { max-width: 900px; }
        .team-intel__intro { font-size: var(--font-sm); color: var(--text-secondary); margin-bottom: var(--space-6); line-height: 1.6; max-width: 640px; }
        .team-section { margin-bottom: var(--space-8); }
        .team-section__title { font-size: var(--font-base); font-weight: var(--weight-semibold); color: var(--text-primary); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2); }
        .team-section__title svg { width: 16px; height: 16px; color: var(--accent-cyan); }
        .team-compare-table { width: 100%; border-collapse: collapse; margin-bottom: var(--space-4); }
        .team-compare-table th, .team-compare-table td { padding: var(--space-2) var(--space-3); text-align: left; font-size: var(--font-sm); border-bottom: 1px solid var(--border-subtle); }
        .team-compare-table th { color: var(--text-muted); font-weight: var(--weight-medium); font-size: var(--font-xs); text-transform: uppercase; letter-spacing: 0.04em; }
        .team-compare-table td { color: var(--text-secondary); }
        .team-compare-table tr:last-child td { border-bottom: none; }
        .team-compare-table td.best { color: var(--signal-strong); font-weight: var(--weight-semibold); }
        .team-compare-table td.worst { color: var(--signal-risk); font-weight: var(--weight-semibold); }
        .alert-card { padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-3); font-size: var(--font-sm); line-height: 1.5; display: flex; align-items: flex-start; gap: var(--space-3); }
        .alert-card--warn { background: rgba(251,191,36,0.06); border: 1px solid rgba(251,191,36,0.15); color: var(--text-secondary); }
        .alert-card--risk { background: rgba(248,113,113,0.06); border: 1px solid rgba(248,113,113,0.15); color: var(--text-secondary); }
        .alert-card--info { background: rgba(0,229,255,0.04); border: 1px solid rgba(0,229,255,0.15); color: var(--text-secondary); }
        .alert-card__icon { flex-shrink: 0; font-size: var(--font-base); line-height: 1.4; }
        .alert-card__icon--warn { color: var(--signal-amber); }
        .alert-card__icon--risk { color: var(--signal-risk); }
        .alert-card__icon--info { color: var(--accent-cyan); }
        .pattern-list { list-style: none; display: flex; flex-direction: column; gap: var(--space-2); }
        .pattern-list li { font-size: var(--font-sm); color: var(--text-secondary); padding: var(--space-3); background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); display: flex; align-items: center; gap: var(--space-3); }
        .pattern-count { font-family: var(--font-mono); font-size: var(--font-xs); font-weight: var(--weight-bold); color: var(--accent-cyan); background: rgba(0,229,255,0.08); padding: 2px 8px; border-radius: var(--radius-full); flex-shrink: 0; }
        .team-empty { text-align: center; padding: var(--space-10); color: var(--text-muted); font-size: var(--font-sm); }

        /* Toast */
        .toast { position: fixed; bottom: var(--space-6); right: var(--space-6); padding: var(--space-3) var(--space-5); background: var(--signal-strong); color: var(--bg-primary); border-radius: var(--radius-md); font-size: var(--font-sm); font-weight: var(--weight-medium); z-index: 1100; animation: fadeInUp 0.2s ease; display: none; }
        .toast.show { display: block; }

        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .dashboard-stats { grid-template-columns: 1fr 1fr; }
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body>
    <div class="app-layout">
        <main class="app-main">
            <div class="content-container">

                <header class="tel-header fade-in-up">
                    <div class="tel-header__label">AI Hub v2.0</div>
                    <h1 class="tel-header__title"><span>Telemetry</span></h1>
                    <p class="tel-header__subtitle">Track recruiting metrics manually. Identify bottlenecks. Measure the impact of AI-powered workflows across the pipeline.</p>
                </header>

                <div class="tel-tabs" role="tablist">
                    <button class="tel-tab active" data-tab="entry" role="tab">Log Entry</button>
                    <button class="tel-tab" data-tab="dashboard" role="tab">Dashboard</button>
                    <button class="tel-tab" data-tab="teamintel" role="tab">Team Intel</button>
                    <button class="tel-tab" data-tab="autopsy" role="tab">Monthly Autopsy</button>
                </div>

                <!-- TAB: Log Entry -->
                <div class="tab-panel active" id="tab-entry">
                    <form class="entry-form" id="entryForm" autocomplete="off">
                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                Entry Details
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Period</label>
                                    <input type="week" class="form-input" id="entryPeriod" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Market / Team</label>
                                    <input type="text" class="form-input" id="entryTeam" placeholder="e.g., EMEA North">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Recruiter (optional)</label>
                                    <input type="text" class="form-input" id="entryRecruiter" placeholder="Your name — for team calibration">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                Pipeline Metrics
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">HM Rejection Rate</label>
                                    <input type="number" class="form-input" id="metricHmReject" min="0" max="100" step="1" placeholder="% of submissions rejected">
                                    <span class="form-hint">% of Confidence Packs rejected by hiring managers</span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Time-to-Shortlist (days)</label>
                                    <input type="number" class="form-input" id="metricTts" min="0" step="0.5" placeholder="Avg days from intake to shortlist">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Truth Check Catch Rate</label>
                                    <input type="number" class="form-input" id="metricTcCatch" min="0" max="100" step="1" placeholder="% flagged as Risk">
                                    <span class="form-hint">% of candidates flagged as Risk during Truth Check</span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Outreach Reply Rate</label>
                                    <input type="number" class="form-input" id="metricReplyRate" min="0" max="100" step="1" placeholder="% responded to first touch">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                                Outcome Tracking
                            </div>
                            <p style="font-size:var(--font-xs);color:var(--text-muted);margin-bottom:var(--space-4);line-height:1.5;">Track whether your process produces results — not just activity. This is the feedback loop that proves verification works.</p>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Confidence Packs Sent</label>
                                    <input type="number" class="form-input" id="outcomeCpSent" min="0" step="1" placeholder="Total CPs submitted to HMs">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">HM Interviews Scheduled</label>
                                    <input type="number" class="form-input" id="outcomeCpInterviews" min="0" step="1" placeholder="CPs that led to interviews">
                                    <span class="form-hint">From Confidence Packs → HM interview</span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Offers Extended</label>
                                    <input type="number" class="form-input" id="outcomeOffers" min="0" step="1" placeholder="Offers made this period">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Offers Accepted</label>
                                    <input type="number" class="form-input" id="outcomeAccepted" min="0" step="1" placeholder="Offers accepted">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Truth Checks Conducted</label>
                                    <input type="number" class="form-input" id="outcomeTcDone" min="0" step="1" placeholder="Total screens run">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Truth Check No-Go Calls</label>
                                    <input type="number" class="form-input" id="outcomeTcNoGo" min="0" step="1" placeholder="Candidates screened out">
                                    <span class="form-hint">Candidates stopped before submission — bad hires prevented</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                                Outreach by Angle
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Angle A: Mission</label>
                                    <input type="number" class="form-input" id="angleA" min="0" max="100" step="1" placeholder="Reply rate %">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Angle B: Craft</label>
                                    <input type="number" class="form-input" id="angleB" min="0" max="100" step="1" placeholder="Reply rate %">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Angle C: Career</label>
                                    <input type="number" class="form-input" id="angleC" min="0" max="100" step="1" placeholder="Reply rate %">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Assets Created</label>
                                    <input type="number" class="form-input" id="metricAssets" min="0" step="1" placeholder="New assets this period">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                                AI Usage Attribution
                            </div>
                            <p style="font-size:var(--font-xs);color:var(--text-muted);margin-bottom:var(--space-4);line-height:1.5;">Capture AI effort and usage so outcome lifts can be linked to specific prompts and assets.</p>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Hours on AI Tasks</label>
                                    <input type="number" class="form-input" id="aiHours" min="0" step="0.25" placeholder="e.g., 6.5 hours">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Prompts Executed</label>
                                    <input type="number" class="form-input" id="aiPromptsUsed" min="0" step="1" placeholder="Count this period">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Assets Applied</label>
                                    <input type="number" class="form-input" id="aiAssetsApplied" min="0" step="1" placeholder="Templates/checklists reused">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">AI-Assisted CP Sent</label>
                                    <input type="number" class="form-input" id="aiCpSent" min="0" step="1" placeholder="CPs that used AI output">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">AI-Assisted HM Interviews</label>
                                    <input type="number" class="form-input" id="aiCpInterviews" min="0" step="1" placeholder="AI-assisted CPs to interview">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Prompt IDs Used</label>
                                    <input type="text" class="form-input" id="aiPromptRefs" placeholder="Comma separated, e.g. S1-ROLE, S5-ANGLE-B">
                                    <span class="form-hint">If left blank, auto-filled from Prompt Arsenal copy activity for this week.</span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Asset IDs Applied</label>
                                    <input type="text" class="form-input" id="aiAssetRefs" placeholder="Comma separated, e.g. CP-V2, TC-CHECKLIST">
                                    <span class="form-hint">If left blank, auto-filled from Asset Library copy/download activity for this week.</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4"/><path d="M12 3l8 4v6c0 5-3.5 8.5-8 10-4.5-1.5-8-5-8-10V7l8-4z"/></svg>
                                Verification Quality Audit (Manager)
                            </div>
                            <p style="font-size:var(--font-xs);color:var(--text-muted);margin-bottom:var(--space-4);line-height:1.5;">Verify the verification: track whether Confidence Packs are evidence-traceable, calibrated, and consistent across reviewers.</p>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Packs Audited</label>
                                    <input type="number" class="form-input" id="auditReviewed" min="0" step="1" placeholder="How many CPs were manager-reviewed">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Citation Traceability Pass Rate</label>
                                    <input type="number" class="form-input" id="auditTraceability" min="0" max="100" step="1" placeholder="% claims trace back to source notes">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Inter-Reviewer Consistency</label>
                                    <input type="number" class="form-input" id="auditCalibration" min="0" max="100" step="1" placeholder="% agreement on risk/quality calls">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Risk Flag Tendency</label>
                                    <select class="form-select" id="auditRiskTendency">
                                        <option value="">Select tendency</option>
                                        <option value="conservative">Too conservative (over-flagging)</option>
                                        <option value="balanced">Balanced</option>
                                        <option value="permissive">Too permissive (under-flagging)</option>
                                    </select>
                                </div>
                                <div class="form-group form-group--full">
                                    <label class="form-label">Audit Feedback (optional)</label>
                                    <textarea class="form-textarea" id="auditNotes" rows="2" placeholder="Examples: risk flags too soft, evidence missing quotes, role-passport mapping inconsistent..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                                Decline Reasons (count this period)
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Compensation</label>
                                    <input type="number" class="form-input" id="declineComp" min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Location</label>
                                    <input type="number" class="form-input" id="declineLocation" min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Timing / Notice</label>
                                    <input type="number" class="form-input" id="declineTiming" min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Counter-offer / Stayed</label>
                                    <input type="number" class="form-input" id="declineCounter" min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Role Mismatch</label>
                                    <input type="number" class="form-input" id="declineMismatch" min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Other</label>
                                    <input type="number" class="form-input" id="declineOther" min="0" step="1" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-group form-group--full">
                                <label class="form-label">Notes (optional)</label>
                                <textarea class="form-textarea" id="entryNotes" placeholder="Any context, observations, or anomalies this period..."></textarea>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Save Entry</button>
                            <button type="reset" class="btn-secondary">Clear</button>
                        </div>
                    </form>

                    <!-- Data Log -->
                    <div class="data-log">
                        <div class="data-log__title">
                            <span>Recent Entries</span>
                            <button class="btn-secondary" id="exportLog" style="padding: 4px 12px; font-size: var(--font-xs);">Export CSV</button>
                        </div>
                        <div id="logTable"></div>
                    </div>
                </div>

                <!-- TAB: Dashboard -->
                <div class="tab-panel" id="tab-dashboard">
                    <div class="period-select" id="periodSelect">
                        <button class="period-btn active" data-range="4">Last 4 Weeks</button>
                        <button class="period-btn" data-range="8">Last 8 Weeks</button>
                        <button class="period-btn" data-range="12">Last 12 Weeks</button>
                        <button class="period-btn" data-range="0">All Time</button>
                    </div>

                    <div class="dashboard-stats" id="dashStats"></div>

                    <div class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-card__title">Pipeline Metrics Trend</div>
                            <canvas id="chartTrend"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card__title">Outcome Funnel: CP → Interview → Offer → Accept</div>
                            <canvas id="chartFunnel"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card__title">Outreach by Angle</div>
                            <canvas id="chartAngles"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card__title">Truth Check Effectiveness</div>
                            <canvas id="chartTcEffect"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card__title">Decline Reasons</div>
                            <canvas id="chartDeclines"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card__title">Stage Bottlenecks</div>
                            <canvas id="chartBottlenecks"></canvas>
                        </div>
                    </div>
                </div>

                <!-- TAB: Team Intel -->
                <div class="tab-panel" id="tab-teamintel">
                    <div class="team-intel">
                        <p class="team-intel__intro">Team-level view of metrics, patterns, and calibration alerts. Data is grouped by the Market / Team field from your log entries. When everyone has AI, the teams that share intelligence compound faster.</p>

                        <div class="team-section">
                            <div class="team-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                Team Comparison
                            </div>
                            <div id="teamCompare"></div>
                        </div>

                        <div class="team-section">
                            <div class="team-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                Calibration Alerts
                            </div>
                            <div id="teamAlerts"></div>
                        </div>

                        <div class="team-section">
                            <div class="team-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                Recurring Patterns (from Rituals)
                            </div>
                            <div id="teamPatterns"></div>
                        </div>

                        <div class="team-section">
                            <div class="team-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                                Team Outcomes
                            </div>
                            <div id="teamOutcomes"></div>
                            <div class="chart-grid" style="margin-top:var(--space-4);">
                                <div class="chart-card">
                                    <div class="chart-card__title">Team Comparison: Key Metrics</div>
                                    <canvas id="chartTeamCompare"></canvas>
                                </div>
                                <div class="chart-card">
                                    <div class="chart-card__title">Team Comparison: Outcome Conversion</div>
                                    <canvas id="chartTeamOutcomes"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Monthly Autopsy -->
                <div class="tab-panel" id="tab-autopsy">
                    <div class="autopsy-section">
                        <div class="autopsy-card">
                            <div class="autopsy-card__title">Month</div>
                            <input type="month" class="form-input" id="autopsyMonth" style="max-width: 220px;">
                        </div>

                        <div class="autopsy-card">
                            <div class="autopsy-card__title">What Worked</div>
                            <textarea class="form-textarea" id="autopsyWorked" rows="4" placeholder="Processes, tools, or approaches that delivered results this month..."></textarea>
                        </div>

                        <div class="autopsy-card">
                            <div class="autopsy-card__title">What Didn't</div>
                            <textarea class="form-textarea" id="autopsyFailed" rows="4" placeholder="What underperformed, caused friction, or wasted time..."></textarea>
                        </div>

                        <div class="autopsy-card">
                            <div class="autopsy-card__title">Root Causes</div>
                            <textarea class="form-textarea" id="autopsyRoot" rows="4" placeholder="Why did the failures happen? Volume problem? Relevance problem? Process gap?"></textarea>
                        </div>

                        <div class="autopsy-card">
                            <div class="autopsy-card__title">Actions for Next Month</div>
                            <textarea class="form-textarea" id="autopsyActions" rows="4" placeholder="Specific changes to implement. Who does what, by when..."></textarea>
                        </div>

                        <div class="autopsy-card">
                            <div class="autopsy-card__title">Data Summary (auto-filled from entries)</div>
                            <div id="autopsySummary" style="font-size: var(--font-sm); color: var(--text-secondary); line-height: 1.6;">Select a month above to see aggregated metrics.</div>
                        </div>

                        <div class="form-actions">
                            <button class="btn-primary" id="saveAutopsy">Save Autopsy</button>
                            <button class="btn-secondary" id="printAutopsy">Print</button>
                        </div>

                        <!-- Past Autopsies -->
                        <div class="data-log" style="margin-top: var(--space-10);">
                            <div class="data-log__title"><span>Past Autopsies</span></div>
                            <div id="autopsyLog"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div class="toast" id="toast"></div>

    <script src="../shared/sidebar.js"></script>
    <script src="../shared/v2-footer.js"></script>
    <script src="../shared/export-utils.js"></script>
    <script>
    (function() {
        'use strict';

        var STORAGE_KEY = 'telemetry-entries';
        var AUTOPSY_KEY = 'telemetry-autopsies';
        var AI_USAGE_EVENT_KEY = 'telemetry-ai-usage-events-v1';
        var chartInstances = {};
        var dashRange = 4;

        /* --- Tab Switching --- */
        document.querySelectorAll('.tel-tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tel-tab').forEach(function(t) { t.classList.remove('active'); });
                document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
                this.classList.add('active');
                document.getElementById('tab-' + this.dataset.tab).classList.add('active');
                if (this.dataset.tab === 'dashboard') renderDashboard();
                if (this.dataset.tab === 'teamintel') renderTeamIntel();
            });
        });

        /* --- Storage --- */
        function getEntries() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch(e) { return []; }
        }
        function saveEntries(entries) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        }
        function getAutopsies() {
            try { return JSON.parse(localStorage.getItem(AUTOPSY_KEY)) || []; } catch(e) { return []; }
        }
        function saveAutopsies(list) {
            localStorage.setItem(AUTOPSY_KEY, JSON.stringify(list));
        }
        function getAiUsageEvents() {
            try {
                var raw = localStorage.getItem(AI_USAGE_EVENT_KEY);
                var list = raw ? JSON.parse(raw) : [];
                return Array.isArray(list) ? list : [];
            } catch(e) {
                return [];
            }
        }
        function summarizeAutoAiUsage(period) {
            var summary = {
                promptsUsed: null,
                assetsApplied: null,
                promptRefs: [],
                assetRefs: []
            };
            if (!period) return summary;

            var promptSet = {};
            var assetSet = {};
            var promptCount = 0;
            var assetCount = 0;

            getAiUsageEvents().forEach(function(ev) {
                var evPeriod = ev && ev.period ? String(ev.period) : '';
                if (evPeriod !== period) return;
                if (ev.type === 'prompt') {
                    promptCount += 1;
                    if (ev.refId) promptSet[ev.refId] = true;
                } else if (ev.type === 'asset') {
                    assetCount += 1;
                    if (ev.refId) assetSet[ev.refId] = true;
                }
            });

            if (promptCount > 0) summary.promptsUsed = promptCount;
            if (assetCount > 0) summary.assetsApplied = assetCount;
            summary.promptRefs = Object.keys(promptSet);
            summary.assetRefs = Object.keys(assetSet);
            return summary;
        }
        function pickManualOrAuto(manualValue, autoValue) {
            return manualValue === null || manualValue === undefined ? autoValue : manualValue;
        }
        function mergeUniqueRefs(manualRefs, autoRefs) {
            var out = [];
            var seen = {};
            (manualRefs || []).concat(autoRefs || []).forEach(function(ref) {
                var key = String(ref || '').trim();
                if (!key || seen[key]) return;
                seen[key] = true;
                out.push(key);
            });
            return out;
        }

        /* --- Form Submit --- */
        document.getElementById('entryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var selectedPeriod = document.getElementById('entryPeriod').value;
            var autoAiUsage = summarizeAutoAiUsage(selectedPeriod);
            var aiHours = parseNum('aiHours');
            var aiPromptsUsed = parseNum('aiPromptsUsed');
            var aiAssetsApplied = parseNum('aiAssetsApplied');
            var aiCpSent = parseNum('aiCpSent');
            var aiCpInterviews = parseNum('aiCpInterviews');
            var manualPromptRefs = parseList('aiPromptRefs');
            var manualAssetRefs = parseList('aiAssetRefs');
            var entry = {
                id: Date.now(),
                period: selectedPeriod,
                team: document.getElementById('entryTeam').value,
                recruiter: document.getElementById('entryRecruiter').value,
                hmReject: parseNum('metricHmReject'),
                tts: parseNum('metricTts'),
                tcCatch: parseNum('metricTcCatch'),
                replyRate: parseNum('metricReplyRate'),
                outcomes: {
                    cpSent: parseNum('outcomeCpSent'),
                    cpInterviews: parseNum('outcomeCpInterviews'),
                    offers: parseNum('outcomeOffers'),
                    accepted: parseNum('outcomeAccepted'),
                    tcDone: parseNum('outcomeTcDone'),
                    tcNoGo: parseNum('outcomeTcNoGo')
                },
                angleA: parseNum('angleA'),
                angleB: parseNum('angleB'),
                angleC: parseNum('angleC'),
                assets: parseNum('metricAssets'),
                aiUsage: {
                    hours: aiHours,
                    promptsUsed: pickManualOrAuto(aiPromptsUsed, autoAiUsage.promptsUsed),
                    assetsApplied: pickManualOrAuto(aiAssetsApplied, autoAiUsage.assetsApplied),
                    cpSent: aiCpSent,
                    cpInterviews: aiCpInterviews,
                    promptRefs: mergeUniqueRefs(manualPromptRefs, autoAiUsage.promptRefs),
                    assetRefs: mergeUniqueRefs(manualAssetRefs, autoAiUsage.assetRefs)
                },
                audit: {
                    reviewed: parseNum('auditReviewed'),
                    traceability: parseNum('auditTraceability'),
                    calibration: parseNum('auditCalibration'),
                    riskTendency: (document.getElementById('auditRiskTendency').value || '').trim() || null,
                    notes: document.getElementById('auditNotes').value.trim()
                },
                declines: {
                    compensation: parseNum('declineComp'),
                    location: parseNum('declineLocation'),
                    timing: parseNum('declineTiming'),
                    counter: parseNum('declineCounter'),
                    mismatch: parseNum('declineMismatch'),
                    other: parseNum('declineOther')
                },
                notes: document.getElementById('entryNotes').value,
                createdAt: new Date().toISOString()
            };
            var entries = getEntries();
            entries.unshift(entry);
            saveEntries(entries);
            this.reset();
            renderLog();
            var autoSourcesUsed = autoAiUsage.promptsUsed || autoAiUsage.assetsApplied || autoAiUsage.promptRefs.length || autoAiUsage.assetRefs.length;
            showToast(autoSourcesUsed ? 'Entry saved (auto-filled AI usage)' : 'Entry saved');
        });

        function parseNum(id) {
            var v = document.getElementById(id).value;
            return v === '' ? null : parseFloat(v);
        }
        function parseList(id) {
            var raw = document.getElementById(id).value || '';
            return raw
                .split(',')
                .map(function(v) { return v.trim(); })
                .filter(function(v) { return v.length > 0; });
        }

        /* --- Log Table --- */
        function renderLog() {
            var entries = getEntries();
            var container = document.getElementById('logTable');
            if (entries.length === 0) {
                container.innerHTML = '<div class="log-empty">No entries yet. Submit your first weekly metrics above.</div>';
                return;
            }
            var html = '<table class="log-table"><thead><tr><th>Period</th><th>Team</th><th>HM Rej %</th><th>TTS</th><th>TC Catch</th><th>Reply %</th><th>AI Hrs</th><th>Audit Trace %</th><th>AI CP→Int</th><th>CP→Int</th><th>Offers</th><th></th></tr></thead><tbody>';
            entries.slice(0, 20).forEach(function(e) {
                var o = e.outcomes || {};
                var ai = e.aiUsage || {};
                var audit = e.audit || {};
                html += '<tr>';
                html += '<td>' + esc(e.period) + '</td>';
                html += '<td>' + esc(e.team || '-') + '</td>';
                html += '<td>' + fmt(e.hmReject, '%') + '</td>';
                html += '<td>' + fmt(e.tts, 'd') + '</td>';
                html += '<td>' + fmt(e.tcCatch, '%') + '</td>';
                html += '<td>' + fmt(e.replyRate, '%') + '</td>';
                html += '<td>' + fmt(ai.hours, 'h') + '</td>';
                html += '<td>' + fmt(audit.traceability, '%') + '</td>';
                html += '<td>' + (ai.cpSent ? fmt(ai.cpInterviews) + '/' + fmt(ai.cpSent) : '-') + '</td>';
                html += '<td>' + (o.cpSent ? fmt(o.cpInterviews) + '/' + fmt(o.cpSent) : '-') + '</td>';
                html += '<td>' + (o.offers !== null && o.offers !== undefined ? fmt(o.accepted) + '/' + fmt(o.offers) : '-') + '</td>';
                html += '<td><button class="btn-secondary" style="padding:2px 8px;font-size:11px;" data-delete="' + e.id + '">Del</button></td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;

            container.querySelectorAll('[data-delete]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var id = parseInt(this.dataset.delete);
                    var entries = getEntries().filter(function(e) { return e.id !== id; });
                    saveEntries(entries);
                    renderLog();
                });
            });
        }

        /* --- Dashboard --- */
        function renderDashboard() {
            var entries = getEntries();
            if (dashRange > 0) entries = entries.slice(0, dashRange);

            // Stats
            var stats = calcStats(entries);
            var statsHtml = '';
            var statItems = [
                { label: 'Avg HM Rejection', value: stats.avgHmReject, unit: '%', good: 'low' },
                { label: 'Avg Time-to-Shortlist', value: stats.avgTts, unit: 'd', good: 'low' },
                { label: 'Avg TC Catch Rate', value: stats.avgTcCatch, unit: '%', good: null },
                { label: 'Avg Reply Rate', value: stats.avgReply, unit: '%', good: 'high' },
                { label: 'CP → Interview Rate', value: stats.cpConversion, unit: '%', good: 'high' },
                { label: 'AI CP → Interview Rate', value: stats.aiCpConversion, unit: '%', good: 'high' },
                { label: 'Offer Accept Rate', value: stats.offerAcceptRate, unit: '%', good: 'high' },
                { label: 'AI Hours Logged', value: stats.totalAiHours, unit: 'h', good: null },
                { label: 'Prompts Executed', value: stats.totalAiPromptsUsed, unit: '', good: null },
                { label: 'Assets Applied', value: stats.totalAiAssetsApplied, unit: '', good: null },
                { label: 'Audit Traceability', value: stats.avgAuditTraceability, unit: '%', good: 'high' },
                { label: 'Audit Consistency', value: stats.avgAuditCalibration, unit: '%', good: 'high' },
                { label: 'Packs Audited', value: stats.totalAuditReviewed, unit: '', good: null },
                { label: 'TC Candidates Stopped', value: stats.totalTcNoGo, unit: '', good: null },
                { label: 'Total Entries', value: entries.length, unit: '', good: null }
            ];
            statItems.forEach(function(s) {
                statsHtml += '<div class="stat-card">';
                statsHtml += '<div class="stat-card__value">' + (s.value !== null ? (Math.round(s.value * 10) / 10) + s.unit : '-') + '</div>';
                statsHtml += '<div class="stat-card__label">' + s.label + '</div>';
                statsHtml += '</div>';
            });
            document.getElementById('dashStats').innerHTML = statsHtml;

            // Charts
            renderTrendChart(entries);
            renderFunnelChart(stats);
            renderAnglesChart(entries);
            renderTcEffectChart(entries);
            renderDeclinesChart(entries);
            renderBottlenecksChart(stats);
        }

        function calcStats(entries) {
            var s = {
                avgHmReject: null,
                avgTts: null,
                avgTcCatch: null,
                avgReply: null,
                totalAssets: 0,
                totalCpSent: 0,
                totalCpInterviews: 0,
                totalOffers: 0,
                totalAccepted: 0,
                totalTcDone: 0,
                totalTcNoGo: 0,
                totalAiHours: 0,
                totalAiPromptsUsed: 0,
                totalAiAssetsApplied: 0,
                totalAiCpSent: 0,
                totalAiCpInterviews: 0,
                trackedAiEntries: 0,
                promptRefCounts: {},
                assetRefCounts: {},
                totalAuditReviewed: 0,
                avgAuditTraceability: null,
                avgAuditCalibration: null,
                trackedAuditEntries: 0,
                riskTendencyCounts: { conservative: 0, balanced: 0, permissive: 0 }
            };
            if (entries.length === 0) return s;
            var sums = { hm: 0, hmC: 0, tts: 0, ttsC: 0, tc: 0, tcC: 0, rr: 0, rrC: 0, auditTrace: 0, auditTraceC: 0, auditCal: 0, auditCalC: 0 };
            entries.forEach(function(e) {
                if (e.hmReject !== null) { sums.hm += e.hmReject; sums.hmC++; }
                if (e.tts !== null) { sums.tts += e.tts; sums.ttsC++; }
                if (e.tcCatch !== null) { sums.tc += e.tcCatch; sums.tcC++; }
                if (e.replyRate !== null) { sums.rr += e.replyRate; sums.rrC++; }
                if (e.assets !== null) s.totalAssets += e.assets;
                if (e.outcomes) {
                    if (e.outcomes.cpSent !== null) s.totalCpSent += (e.outcomes.cpSent || 0);
                    if (e.outcomes.cpInterviews !== null) s.totalCpInterviews += (e.outcomes.cpInterviews || 0);
                    if (e.outcomes.offers !== null) s.totalOffers += (e.outcomes.offers || 0);
                    if (e.outcomes.accepted !== null) s.totalAccepted += (e.outcomes.accepted || 0);
                    if (e.outcomes.tcDone !== null) s.totalTcDone += (e.outcomes.tcDone || 0);
                    if (e.outcomes.tcNoGo !== null) s.totalTcNoGo += (e.outcomes.tcNoGo || 0);
                }
                if (e.aiUsage) {
                    var ai = e.aiUsage;
                    if (ai.hours !== null && ai.hours !== undefined) s.totalAiHours += (ai.hours || 0);
                    if (ai.promptsUsed !== null && ai.promptsUsed !== undefined) s.totalAiPromptsUsed += (ai.promptsUsed || 0);
                    if (ai.assetsApplied !== null && ai.assetsApplied !== undefined) s.totalAiAssetsApplied += (ai.assetsApplied || 0);
                    if (ai.cpSent !== null && ai.cpSent !== undefined) s.totalAiCpSent += (ai.cpSent || 0);
                    if (ai.cpInterviews !== null && ai.cpInterviews !== undefined) s.totalAiCpInterviews += (ai.cpInterviews || 0);
                    if (hasAiUsageValue(ai)) s.trackedAiEntries += 1;
                    (ai.promptRefs || []).forEach(function(ref) { incrementCount(s.promptRefCounts, ref); });
                    (ai.assetRefs || []).forEach(function(ref) { incrementCount(s.assetRefCounts, ref); });
                }
                if (e.audit) {
                    var audit = e.audit;
                    if (audit.reviewed !== null && audit.reviewed !== undefined) s.totalAuditReviewed += (audit.reviewed || 0);
                    if (audit.traceability !== null && audit.traceability !== undefined) { sums.auditTrace += audit.traceability; sums.auditTraceC++; }
                    if (audit.calibration !== null && audit.calibration !== undefined) { sums.auditCal += audit.calibration; sums.auditCalC++; }
                    if (audit.riskTendency && s.riskTendencyCounts[audit.riskTendency] !== undefined) {
                        s.riskTendencyCounts[audit.riskTendency] += 1;
                    }
                    if (hasAuditValue(audit)) s.trackedAuditEntries += 1;
                }
            });
            if (sums.hmC) s.avgHmReject = sums.hm / sums.hmC;
            if (sums.ttsC) s.avgTts = sums.tts / sums.ttsC;
            if (sums.tcC) s.avgTcCatch = sums.tc / sums.tcC;
            if (sums.rrC) s.avgReply = sums.rr / sums.rrC;
            if (sums.auditTraceC) s.avgAuditTraceability = sums.auditTrace / sums.auditTraceC;
            if (sums.auditCalC) s.avgAuditCalibration = sums.auditCal / sums.auditCalC;
            s.cpConversion = s.totalCpSent > 0 ? Math.round(s.totalCpInterviews / s.totalCpSent * 100) : null;
            s.aiCpConversion = s.totalAiCpSent > 0 ? Math.round(s.totalAiCpInterviews / s.totalAiCpSent * 100) : null;
            s.offerAcceptRate = s.totalOffers > 0 ? Math.round(s.totalAccepted / s.totalOffers * 100) : null;
            s.tcStopRate = s.totalTcDone > 0 ? Math.round(s.totalTcNoGo / s.totalTcDone * 100) : null;
            return s;
        }

        function incrementCount(map, rawKey) {
            var key = (rawKey || '').trim();
            if (!key) return;
            map[key] = (map[key] || 0) + 1;
        }

        function hasAiUsageValue(ai) {
            if (!ai) return false;
            return ai.hours !== null && ai.hours !== undefined ||
                ai.promptsUsed !== null && ai.promptsUsed !== undefined ||
                ai.assetsApplied !== null && ai.assetsApplied !== undefined ||
                ai.cpSent !== null && ai.cpSent !== undefined ||
                ai.cpInterviews !== null && ai.cpInterviews !== undefined ||
                (Array.isArray(ai.promptRefs) && ai.promptRefs.length > 0) ||
                (Array.isArray(ai.assetRefs) && ai.assetRefs.length > 0);
        }

        function hasAuditValue(audit) {
            if (!audit) return false;
            return audit.reviewed !== null && audit.reviewed !== undefined ||
                audit.traceability !== null && audit.traceability !== undefined ||
                audit.calibration !== null && audit.calibration !== undefined ||
                (audit.riskTendency && String(audit.riskTendency).trim().length > 0) ||
                (audit.notes && String(audit.notes).trim().length > 0);
        }

        function renderTrendChart(entries) {
            var reversed = entries.slice().reverse();
            var labels = reversed.map(function(e) { return e.period; });
            destroyChart('chartTrend');
            var ctx = document.getElementById('chartTrend').getContext('2d');
            chartInstances['chartTrend'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'HM Reject %', data: reversed.map(function(e) { return e.hmReject; }), borderColor: '#f87171', tension: 0.3, pointRadius: 3 },
                        { label: 'Reply Rate %', data: reversed.map(function(e) { return e.replyRate; }), borderColor: '#00e5ff', tension: 0.3, pointRadius: 3 },
                        { label: 'TC Catch %', data: reversed.map(function(e) { return e.tcCatch; }), borderColor: '#34d399', tension: 0.3, pointRadius: 3 }
                    ]
                },
                options: chartOpts('Trend over time')
            });
        }

        function renderFunnelChart(stats) {
            destroyChart('chartFunnel');
            var ctx = document.getElementById('chartFunnel').getContext('2d');
            chartInstances['chartFunnel'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['CPs Sent', 'HM Interviews', 'Offers', 'Accepted'],
                    datasets: [{
                        label: 'Count',
                        data: [stats.totalCpSent, stats.totalCpInterviews, stats.totalOffers, stats.totalAccepted],
                        backgroundColor: ['rgba(0,229,255,0.7)', 'rgba(167,139,250,0.7)', 'rgba(251,191,36,0.7)', 'rgba(52,211,153,0.7)'],
                        borderRadius: 6
                    }]
                },
                options: chartOpts('Confidence Pack → Hire conversion')
            });
        }

        function renderTcEffectChart(entries) {
            var reversed = entries.slice().reverse();
            var labels = reversed.map(function(e) { return e.period; });
            var tcDone = reversed.map(function(e) { return e.outcomes ? e.outcomes.tcDone : null; });
            var tcNoGo = reversed.map(function(e) { return e.outcomes ? e.outcomes.tcNoGo : null; });
            destroyChart('chartTcEffect');
            var ctx = document.getElementById('chartTcEffect').getContext('2d');
            chartInstances['chartTcEffect'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Truth Checks Done', data: tcDone, backgroundColor: 'rgba(0,229,255,0.5)', borderRadius: 4 },
                        { label: 'No-Go Calls (Bad Hires Prevented)', data: tcNoGo, backgroundColor: 'rgba(248,113,113,0.6)', borderRadius: 4 }
                    ]
                },
                options: chartOpts('Truth Check impact — candidates stopped before submission')
            });
        }

        function renderAnglesChart(entries) {
            var totals = { a: [], b: [], c: [] };
            entries.forEach(function(e) {
                if (e.angleA !== null) totals.a.push(e.angleA);
                if (e.angleB !== null) totals.b.push(e.angleB);
                if (e.angleC !== null) totals.c.push(e.angleC);
            });
            destroyChart('chartAngles');
            var ctx = document.getElementById('chartAngles').getContext('2d');
            chartInstances['chartAngles'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mission (A)', 'Craft (B)', 'Career (C)'],
                    datasets: [{
                        label: 'Avg Reply Rate %',
                        data: [avg(totals.a), avg(totals.b), avg(totals.c)],
                        backgroundColor: ['rgba(244,114,182,0.7)', 'rgba(167,139,250,0.7)', 'rgba(251,191,36,0.7)'],
                        borderRadius: 6
                    }]
                },
                options: chartOpts('Average reply rate by outreach angle')
            });
        }

        function renderDeclinesChart(entries) {
            var totals = { compensation: 0, location: 0, timing: 0, counter: 0, mismatch: 0, other: 0 };
            entries.forEach(function(e) {
                if (!e.declines) return;
                Object.keys(totals).forEach(function(k) {
                    totals[k] += (e.declines[k] || 0);
                });
            });
            destroyChart('chartDeclines');
            var ctx = document.getElementById('chartDeclines').getContext('2d');
            chartInstances['chartDeclines'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Compensation', 'Location', 'Timing', 'Counter-offer', 'Mismatch', 'Other'],
                    datasets: [{
                        data: Object.values(totals),
                        backgroundColor: ['#f87171', '#60a5fa', '#fbbf24', '#c084fc', '#fb923c', '#6b7280'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#a1a1b5', font: { size: 11 }, padding: 12 } }
                    }
                }
            });
        }

        function renderBottlenecksChart(stats) {
            destroyChart('chartBottlenecks');
            var ctx = document.getElementById('chartBottlenecks').getContext('2d');
            chartInstances['chartBottlenecks'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['HM Rejection', 'Time-to-Shortlist', 'TC Catch Rate', 'Reply Rate'],
                    datasets: [{
                        label: 'Current Average',
                        data: [
                            stats.avgHmReject || 0,
                            stats.avgTts ? Math.min(stats.avgTts * 5, 100) : 0,
                            stats.avgTcCatch || 0,
                            100 - (stats.avgReply || 0)
                        ],
                        backgroundColor: function(ctx) {
                            var v = ctx.raw;
                            return v > 60 ? 'rgba(248,113,113,0.7)' : v > 30 ? 'rgba(251,191,36,0.7)' : 'rgba(52,211,153,0.7)';
                        },
                        borderRadius: 6
                    }]
                },
                options: chartOpts('Higher = more friction (bottleneck)')
            });
        }

        function chartOpts(subtitle) {
            return {
                responsive: true,
                scales: {
                    x: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                    y: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.06)' }, beginAtZero: true }
                },
                plugins: {
                    legend: { labels: { color: '#a1a1b5', font: { size: 11 }, padding: 10 } },
                    tooltip: { backgroundColor: '#1a1c23', titleColor: '#fff', bodyColor: '#d1d5db', borderColor: '#2a2d37', borderWidth: 1 }
                }
            };
        }

        function destroyChart(id) {
            if (chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; }
        }

        /* --- Period Select --- */
        document.getElementById('periodSelect').addEventListener('click', function(e) {
            var btn = e.target.closest('.period-btn');
            if (!btn) return;
            this.querySelectorAll('.period-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            dashRange = parseInt(btn.dataset.range);
            renderDashboard();
        });

        /* --- Ritual Integration --- */
        function pullRitualData(month) {
            var ritualData;
            try { ritualData = JSON.parse(localStorage.getItem('ritual-entries')) || {}; } catch(e) { return ''; }
            var wins = [];
            var misses = [];
            var assets = [];
            var blockers = [];

            // Find all weeks that fall in this month (YYYY-MM → YYYY-Wxx)
            Object.keys(ritualData).forEach(function(weekKey) {
                var weekData = ritualData[weekKey];
                // Convert week key to approximate month: parse YYYY-Wxx
                var match = weekKey.match(/^(\d{4})-W(\d{2})$/);
                if (!match) return;
                var yr = parseInt(match[1]);
                var wk = parseInt(match[2]);
                // Approximate: week 1 = Jan, week 5 = Feb, etc. (rough month mapping)
                var approxMonth = Math.ceil(wk / 4.33);
                var monthStr = yr + '-' + String(approxMonth).padStart(2, '0');
                if (monthStr !== month) return;

                // Collect Friday ritual data
                if (weekData.friday) {
                    if (weekData.friday.winDemo) wins.push(weekData.friday.winDemo);
                    if (weekData.friday.missShare) misses.push(weekData.friday.missShare);
                    if (weekData.friday.assetCapture) assets.push(weekData.friday.assetCapture);
                }
                // Collect Monday blocker data
                if (weekData.monday && weekData.monday.topBlocker) {
                    blockers.push(weekData.monday.topBlocker);
                }
            });

            if (wins.length === 0 && misses.length === 0 && assets.length === 0) return '';

            var html = '<p style="font-weight:var(--weight-semibold);color:var(--signal-strong);">From Friday Rituals</p>';
            if (wins.length > 0) {
                html += '<p><strong>Wins (' + wins.length + '):</strong></p><ul style="margin:0 0 var(--space-2) var(--space-4);font-size:var(--font-sm);">';
                wins.forEach(function(w) { html += '<li>' + esc(w) + '</li>'; });
                html += '</ul>';
            }
            if (misses.length > 0) {
                html += '<p><strong>Misses (' + misses.length + '):</strong></p><ul style="margin:0 0 var(--space-2) var(--space-4);font-size:var(--font-sm);">';
                misses.forEach(function(m) { html += '<li>' + esc(m) + '</li>'; });
                html += '</ul>';
            }
            if (assets.length > 0) {
                html += '<p><strong>Assets Captured:</strong> ' + assets.map(esc).join(', ') + '</p>';
            }
            if (blockers.length > 0) {
                html += '<p><strong>Recurring Blockers:</strong> ' + blockers.map(esc).join('; ') + '</p>';
            }

            // Also pull ritual postmortem if it exists
            var postmortems;
            try { postmortems = JSON.parse(localStorage.getItem('ritual-postmortems')) || []; } catch(e) { postmortems = []; }
            var pm = postmortems.find(function(p) { return p.month === month; });
            if (pm) {
                html += '<hr style="border-color:var(--border-subtle);margin:var(--space-2) 0;">';
                html += '<p style="font-weight:var(--weight-semibold);color:var(--signal-amber);">From Ritual Postmortem</p>';
                if (pm.wins) html += '<p><strong>Top Wins:</strong> ' + esc(pm.wins.substring(0, 200)) + '</p>';
                if (pm.misses) html += '<p><strong>Top Misses:</strong> ' + esc(pm.misses.substring(0, 200)) + '</p>';
                if (pm.changes) html += '<p><strong>Changes Planned:</strong> ' + esc(pm.changes.substring(0, 200)) + '</p>';
            }
            return html;
        }

        function topUsageRefs(refCounts, limit) {
            return Object.keys(refCounts || {})
                .map(function(ref) { return { ref: ref, count: refCounts[ref] }; })
                .sort(function(a, b) { return b.count - a.count; })
                .slice(0, limit || 5);
        }

        function dominantRiskTendency(counts) {
            var entries = Object.keys(counts || {}).map(function(key) { return { key: key, count: counts[key] || 0 }; });
            entries.sort(function(a, b) { return b.count - a.count; });
            if (!entries.length || entries[0].count === 0) return null;
            return entries[0].key;
        }

        /* --- Autopsy --- */
        document.getElementById('autopsyMonth').addEventListener('change', function() {
            var month = this.value;
            if (!month) return;
            var entries = getEntries().filter(function(e) {
                return e.period && e.period.substring(0, 7) === month;
            });
            var stats = calcStats(entries);
            var html = '<p><strong>' + entries.length + '</strong> entries for ' + month + '</p>';
            if (entries.length > 0) {
                html += '<p>Avg HM Rejection: <strong>' + fmt(stats.avgHmReject, '%') + '</strong></p>';
                html += '<p>Avg Time-to-Shortlist: <strong>' + fmt(stats.avgTts, 'd') + '</strong></p>';
                html += '<p>Avg TC Catch Rate: <strong>' + fmt(stats.avgTcCatch, '%') + '</strong></p>';
                html += '<p>Avg Reply Rate: <strong>' + fmt(stats.avgReply, '%') + '</strong></p>';
                html += '<p>Assets Created: <strong>' + stats.totalAssets + '</strong></p>';
                if (stats.trackedAuditEntries > 0) {
                    var dominantTendency = dominantRiskTendency(stats.riskTendencyCounts);
                    html += '<hr style="border-color:var(--border-subtle);margin:var(--space-3) 0;">';
                    html += '<p style="font-weight:var(--weight-semibold);color:var(--accent-cyan);">Verification Quality Audit</p>';
                    html += '<p>Packs audited: <strong>' + stats.totalAuditReviewed + '</strong></p>';
                    html += '<p>Citation traceability pass rate: <strong>' + fmt(stats.avgAuditTraceability, '%') + '</strong></p>';
                    html += '<p>Inter-reviewer consistency: <strong>' + fmt(stats.avgAuditCalibration, '%') + '</strong></p>';
                    if (dominantTendency) {
                        html += '<p>Risk-flag tendency: <strong>' + esc(dominantTendency) + '</strong></p>';
                    }
                }
                if (stats.trackedAiEntries > 0) {
                    var topPromptRefs = topUsageRefs(stats.promptRefCounts, 5);
                    var topAssetRefs = topUsageRefs(stats.assetRefCounts, 5);
                    html += '<hr style="border-color:var(--border-subtle);margin:var(--space-3) 0;">';
                    html += '<p style="font-weight:var(--weight-semibold);color:var(--accent-cyan);">AI Usage Attribution</p>';
                    html += '<p>Entries with AI logs: <strong>' + stats.trackedAiEntries + '</strong></p>';
                    html += '<p>AI hours: <strong>' + fmt(stats.totalAiHours, 'h') + '</strong>, prompts executed: <strong>' + stats.totalAiPromptsUsed + '</strong>, assets applied: <strong>' + stats.totalAiAssetsApplied + '</strong></p>';
                    if (stats.totalAiCpSent > 0) {
                        html += '<p>AI-assisted CPs: <strong>' + stats.totalAiCpSent + '</strong> → interviews: <strong>' + stats.totalAiCpInterviews + '</strong> (' + (stats.aiCpConversion || 0) + '% conversion)</p>';
                    }
                    if (topPromptRefs.length > 0) {
                        html += '<p>Top prompts used: <strong>' + topPromptRefs.map(function(p) { return esc(p.ref) + ' (' + p.count + 'x)'; }).join(', ') + '</strong></p>';
                    }
                    if (topAssetRefs.length > 0) {
                        html += '<p>Top assets applied: <strong>' + topAssetRefs.map(function(a) { return esc(a.ref) + ' (' + a.count + 'x)'; }).join(', ') + '</strong></p>';
                    }
                }
                if (stats.totalCpSent > 0) {
                    html += '<hr style="border-color:var(--border-subtle);margin:var(--space-3) 0;">';
                    html += '<p style="font-weight:var(--weight-semibold);color:var(--accent-cyan);">Outcome Tracking</p>';
                    html += '<p>Confidence Packs Sent: <strong>' + stats.totalCpSent + '</strong> → Interviews: <strong>' + stats.totalCpInterviews + '</strong> (' + (stats.cpConversion || 0) + '% conversion)</p>';
                    html += '<p>Offers: <strong>' + stats.totalOffers + '</strong> → Accepted: <strong>' + stats.totalAccepted + '</strong> (' + (stats.offerAcceptRate || 0) + '% accept rate)</p>';
                }
                if (stats.totalTcDone > 0) {
                    html += '<p>Truth Checks: <strong>' + stats.totalTcDone + '</strong> conducted, <strong>' + stats.totalTcNoGo + '</strong> No-Go calls (' + (stats.tcStopRate || 0) + '% stop rate)</p>';
                }
            }

            // Pull ritual data for this month
            var ritualHtml = pullRitualData(month);
            if (ritualHtml) {
                html += '<hr style="border-color:var(--border-subtle);margin:var(--space-3) 0;">';
                html += ritualHtml;
            }

            document.getElementById('autopsySummary').innerHTML = html;

            // Load existing autopsy
            var autopsies = getAutopsies();
            var existing = autopsies.find(function(a) { return a.month === month; });
            if (existing) {
                document.getElementById('autopsyWorked').value = existing.worked || '';
                document.getElementById('autopsyFailed').value = existing.failed || '';
                document.getElementById('autopsyRoot').value = existing.root || '';
                document.getElementById('autopsyActions').value = existing.actions || '';
            }
        });

        document.getElementById('saveAutopsy').addEventListener('click', function() {
            var month = document.getElementById('autopsyMonth').value;
            if (!month) { showToast('Select a month first'); return; }
            var autopsy = {
                month: month,
                worked: document.getElementById('autopsyWorked').value,
                failed: document.getElementById('autopsyFailed').value,
                root: document.getElementById('autopsyRoot').value,
                actions: document.getElementById('autopsyActions').value,
                savedAt: new Date().toISOString()
            };
            var list = getAutopsies();
            var idx = list.findIndex(function(a) { return a.month === month; });
            if (idx >= 0) list[idx] = autopsy; else list.unshift(autopsy);
            saveAutopsies(list);
            renderAutopsyLog();
            showToast('Autopsy saved');
        });

        document.getElementById('printAutopsy').addEventListener('click', function() {
            var month = document.getElementById('autopsyMonth').value || 'Unknown';
            var content = '<h2>Monthly Autopsy: ' + month + '</h2>';
            content += '<h3>What Worked</h3><p>' + esc(document.getElementById('autopsyWorked').value) + '</p>';
            content += '<h3>What Didn\'t</h3><p>' + esc(document.getElementById('autopsyFailed').value) + '</p>';
            content += '<h3>Root Causes</h3><p>' + esc(document.getElementById('autopsyRoot').value) + '</p>';
            content += '<h3>Actions</h3><p>' + esc(document.getElementById('autopsyActions').value) + '</p>';
            content += '<h3>Data Summary (Metrics + Outcomes + Rituals)</h3>' + document.getElementById('autopsySummary').innerHTML;
            if (window.ExportUtils) ExportUtils.printContent('Monthly Autopsy — ' + month, content);
        });

        function renderAutopsyLog() {
            var list = getAutopsies();
            var container = document.getElementById('autopsyLog');
            if (list.length === 0) {
                container.innerHTML = '<div class="log-empty">No autopsies yet.</div>';
                return;
            }
            var html = '<table class="log-table"><thead><tr><th>Month</th><th>Saved</th><th>Actions</th></tr></thead><tbody>';
            list.forEach(function(a) {
                html += '<tr><td>' + esc(a.month) + '</td><td>' + new Date(a.savedAt).toLocaleDateString() + '</td>';
                html += '<td>' + esc((a.actions || '').substring(0, 80)) + (a.actions && a.actions.length > 80 ? '...' : '') + '</td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        /* --- Team Intelligence --- */
        function renderTeamIntel() {
            var entries = getEntries();
            var teamMap = groupByTeam(entries);
            var teams = Object.keys(teamMap);

            if (teams.length === 0) {
                document.getElementById('teamCompare').innerHTML = '<div class="team-empty">No entries yet. Log weekly metrics with a Market / Team name to see team intelligence.</div>';
                document.getElementById('teamAlerts').innerHTML = '';
                document.getElementById('teamPatterns').innerHTML = '';
                document.getElementById('teamOutcomes').innerHTML = '';
                return;
            }

            renderTeamComparison(teamMap, teams);
            renderCalibrationAlerts(teamMap, teams);
            renderRitualPatterns();
            renderTeamOutcomes(teamMap, teams);
            renderTeamCompareChart(teamMap, teams);
            renderTeamOutcomesChart(teamMap, teams);
        }

        function groupByTeam(entries) {
            var map = {};
            entries.forEach(function(e) {
                var team = (e.team || '').trim() || 'Unassigned';
                if (!map[team]) map[team] = [];
                map[team].push(e);
            });
            return map;
        }

        function renderTeamComparison(teamMap, teams) {
            if (teams.length < 2) {
                document.getElementById('teamCompare').innerHTML = '<div class="alert-card alert-card--info"><span class="alert-card__icon alert-card__icon--info">i</span><span>Only one team found (' + esc(teams[0]) + ' with ' + teamMap[teams[0]].length + ' entries). Add entries with different Market / Team names to see comparisons.</span></div>';
                return;
            }

            var rows = teams.map(function(team) {
                var stats = calcStats(teamMap[team]);
                return { team: team, count: teamMap[team].length, stats: stats };
            });

            // Find best/worst per metric
            var metrics = ['avgHmReject', 'avgTts', 'avgTcCatch', 'avgReply', 'cpConversion', 'offerAcceptRate', 'avgAuditTraceability'];
            var isLowerBetter = { avgHmReject: true, avgTts: true, avgTcCatch: false, avgReply: false, cpConversion: false, offerAcceptRate: false, avgAuditTraceability: false };
            var bestWorst = {};
            metrics.forEach(function(m) {
                var vals = rows.filter(function(r) { return r.stats[m] !== null; }).map(function(r) { return { team: r.team, val: r.stats[m] }; });
                if (vals.length < 2) return;
                vals.sort(function(a, b) { return a.val - b.val; });
                if (isLowerBetter[m]) {
                    bestWorst[m] = { best: vals[0].team, worst: vals[vals.length - 1].team };
                } else {
                    bestWorst[m] = { best: vals[vals.length - 1].team, worst: vals[0].team };
                }
            });

            var html = '<table class="team-compare-table"><thead><tr><th>Team</th><th>Entries</th><th>HM Rej %</th><th>TTS (d)</th><th>TC Catch</th><th>Reply %</th><th>CP→Int %</th><th>Offer Accept %</th><th>Audit Trace %</th></tr></thead><tbody>';
            rows.forEach(function(r) {
                html += '<tr>';
                html += '<td><strong>' + esc(r.team) + '</strong></td>';
                html += '<td>' + r.count + '</td>';
                html += '<td class="' + cellClass('avgHmReject', r.team, bestWorst) + '">' + fmt(r.stats.avgHmReject, '%') + '</td>';
                html += '<td class="' + cellClass('avgTts', r.team, bestWorst) + '">' + fmt(r.stats.avgTts, 'd') + '</td>';
                html += '<td>' + fmt(r.stats.avgTcCatch, '%') + '</td>';
                html += '<td class="' + cellClass('avgReply', r.team, bestWorst) + '">' + fmt(r.stats.avgReply, '%') + '</td>';
                html += '<td class="' + cellClass('cpConversion', r.team, bestWorst) + '">' + fmt(r.stats.cpConversion, '%') + '</td>';
                html += '<td class="' + cellClass('offerAcceptRate', r.team, bestWorst) + '">' + fmt(r.stats.offerAcceptRate, '%') + '</td>';
                html += '<td class="' + cellClass('avgAuditTraceability', r.team, bestWorst) + '">' + fmt(r.stats.avgAuditTraceability, '%') + '</td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            html += '<p style="font-size:var(--font-xs);color:var(--text-muted);">Green = best performing, Red = needs attention. Differences above 15pp may indicate calibration issues.</p>';
            document.getElementById('teamCompare').innerHTML = html;
        }

        function cellClass(metric, team, bestWorst) {
            if (!bestWorst[metric]) return '';
            if (bestWorst[metric].best === team) return 'best';
            if (bestWorst[metric].worst === team) return 'worst';
            return '';
        }

        function renderCalibrationAlerts(teamMap, teams) {
            var alerts = [];

            if (teams.length >= 2) {
                // Check TC Catch Rate variance — if teams score very differently, calibration needed
                var tcRates = [];
                teams.forEach(function(team) {
                    var stats = calcStats(teamMap[team]);
                    if (stats.avgTcCatch !== null) tcRates.push({ team: team, rate: stats.avgTcCatch });
                });
                if (tcRates.length >= 2) {
                    var minTc = tcRates.reduce(function(a, b) { return a.rate < b.rate ? a : b; });
                    var maxTc = tcRates.reduce(function(a, b) { return a.rate > b.rate ? a : b; });
                    var spread = maxTc.rate - minTc.rate;
                    if (spread > 15) {
                        alerts.push({ type: 'risk', msg: 'Truth Check Calibration Gap: ' + esc(maxTc.team) + ' flags ' + fmt(maxTc.rate, '%') + ' while ' + esc(minTc.team) + ' flags ' + fmt(minTc.rate, '%') + '. A ' + Math.round(spread) + 'pp spread suggests different people score "Strong" and "Risk" differently. Run a cross-team calibration session.' });
                    }
                }

                // Check HM rejection variance
                var hmRates = [];
                teams.forEach(function(team) {
                    var stats = calcStats(teamMap[team]);
                    if (stats.avgHmReject !== null) hmRates.push({ team: team, rate: stats.avgHmReject });
                });
                if (hmRates.length >= 2) {
                    var minHm = hmRates.reduce(function(a, b) { return a.rate < b.rate ? a : b; });
                    var maxHm = hmRates.reduce(function(a, b) { return a.rate > b.rate ? a : b; });
                    var hmSpread = maxHm.rate - minHm.rate;
                    if (hmSpread > 20) {
                        alerts.push({ type: 'warn', msg: 'HM Rejection Spread: ' + esc(maxHm.team) + ' has ' + fmt(maxHm.rate, '%') + ' rejection vs ' + esc(minHm.team) + ' at ' + fmt(minHm.rate, '%') + '. Investigate whether this is a team quality issue or different HM expectations.' });
                    }
                }

                // Check if any team has zero outcome tracking
                teams.forEach(function(team) {
                    var stats = calcStats(teamMap[team]);
                    if (stats.totalCpSent === 0 && teamMap[team].length >= 4) {
                        alerts.push({ type: 'warn', msg: esc(team) + ' has ' + teamMap[team].length + ' entries but zero Outcome Tracking data. Without CP→interview→offer data, you cannot prove verification works.' });
                    }
                });

                teams.forEach(function(team) {
                    var stats = calcStats(teamMap[team]);
                    if (stats.trackedAiEntries === 0 && teamMap[team].length >= 4) {
                        alerts.push({ type: 'warn', msg: esc(team) + ' has ' + teamMap[team].length + ' entries but zero AI Usage Attribution data. Log AI hours, prompts, and assets to isolate AI impact from general process changes.' });
                    }
                });

                teams.forEach(function(team) {
                    var stats = calcStats(teamMap[team]);
                    if (stats.trackedAuditEntries === 0 && teamMap[team].length >= 4) {
                        alerts.push({ type: 'warn', msg: esc(team) + ' has ' + teamMap[team].length + ' entries but zero Verification Quality Audit data. Add manager audit checks to confirm evidence traceability and calibration quality.' });
                    }
                });
            }

            // Single team alerts
            var allStats = calcStats(getEntries());
            if (allStats.avgHmReject !== null && allStats.avgHmReject > 40) {
                alerts.push({ type: 'risk', msg: 'Overall HM Rejection is ' + fmt(allStats.avgHmReject, '%') + ' — more than 4 in 10 submissions rejected. This usually traces back to Stage 1 (Role Passport) alignment issues.' });
            }
            if (allStats.avgReply !== null && allStats.avgReply < 15) {
                alerts.push({ type: 'warn', msg: 'Overall Reply Rate is ' + fmt(allStats.avgReply, '%') + ' — below industry benchmark. Consider running the Outreach Angle A/B/C analysis and reviewing Stage 5 messaging.' });
            }
            if (allStats.avgAuditTraceability !== null && allStats.avgAuditTraceability < 80) {
                alerts.push({ type: 'risk', msg: 'Audit traceability pass rate is ' + fmt(allStats.avgAuditTraceability, '%') + ' — below quality threshold. Tighten Confidence Pack citation discipline and source-link checks.' });
            }
            if (allStats.avgAuditCalibration !== null && allStats.avgAuditCalibration < 70) {
                alerts.push({ type: 'warn', msg: 'Inter-reviewer consistency is ' + fmt(allStats.avgAuditCalibration, '%') + '. Run a calibration session with shared examples and scoring anchors.' });
            }
            var tendencyTotal = (allStats.riskTendencyCounts.conservative || 0) + (allStats.riskTendencyCounts.balanced || 0) + (allStats.riskTendencyCounts.permissive || 0);
            if (tendencyTotal >= 4) {
                var dominant = dominantRiskTendency(allStats.riskTendencyCounts);
                var dominantCount = dominant ? (allStats.riskTendencyCounts[dominant] || 0) : 0;
                var dominantShare = tendencyTotal > 0 ? (dominantCount / tendencyTotal) * 100 : 0;
                if (dominant && dominant !== 'balanced' && dominantShare >= 70) {
                    alerts.push({ type: 'warn', msg: 'Risk-flag tendency skews ' + esc(dominant) + ' (' + Math.round(dominantShare) + '%). Provide feedback loops so teams neither over-flag nor miss material risks.' });
                }
            }

            var html = '';
            if (alerts.length === 0) {
                html = '<div class="alert-card alert-card--info"><span class="alert-card__icon alert-card__icon--info">&#10003;</span><span>No calibration alerts. Metrics are within expected variance across teams.</span></div>';
            } else {
                alerts.forEach(function(a) {
                    html += '<div class="alert-card alert-card--' + a.type + '">';
                    html += '<span class="alert-card__icon alert-card__icon--' + a.type + '">' + (a.type === 'risk' ? '!' : '&#9888;') + '</span>';
                    html += '<span>' + a.msg + '</span>';
                    html += '</div>';
                });
            }
            document.getElementById('teamAlerts').innerHTML = html;
        }

        function renderRitualPatterns() {
            var ritualData;
            try { ritualData = JSON.parse(localStorage.getItem('ritual-entries')) || {}; } catch(e) { ritualData = {}; }
            var weeks = Object.keys(ritualData);

            if (weeks.length === 0) {
                document.getElementById('teamPatterns').innerHTML = '<div class="alert-card alert-card--info"><span class="alert-card__icon alert-card__icon--info">i</span><span>No ritual data found. Complete Team Rituals each week to surface recurring patterns here.</span></div>';
                return;
            }

            // Aggregate patterns
            var blockerCounts = {};
            var diagnosisCounts = { volume: 0, relevance: 0 };
            var winThemes = {};
            var missThemes = {};
            var stuckCount = 0;

            weeks.forEach(function(weekKey) {
                var data = ritualData[weekKey];

                // Monday blockers
                if (data.monday && data.monday.topBlocker) {
                    var blocker = data.monday.topBlocker.trim().toLowerCase();
                    if (blocker) {
                        blockerCounts[blocker] = (blockerCounts[blocker] || 0) + 1;
                    }
                }

                // Wednesday diagnoses
                if (data.wednesday) {
                    var diags = data.wednesday.diagnoses || [];
                    diags.forEach(function(d) {
                        if (d === 'volume') diagnosisCounts.volume++;
                        if (d === 'relevance') diagnosisCounts.relevance++;
                    });
                    var roles = data.wednesday.stuckRoles || [];
                    stuckCount += roles.filter(Boolean).length;
                }

                // Friday wins/misses (extract themes by counting words > 4 chars)
                if (data.friday && data.friday.winDemo) {
                    var theme = data.friday.winDemo.trim().substring(0, 60);
                    if (theme) winThemes[theme] = (winThemes[theme] || 0) + 1;
                }
                if (data.friday && data.friday.missShare) {
                    var missTheme = data.friday.missShare.trim().substring(0, 60);
                    if (missTheme) missThemes[missTheme] = (missThemes[missTheme] || 0) + 1;
                }
            });

            var html = '';

            // Stuck role diagnosis breakdown
            if (stuckCount > 0) {
                var totalDiag = diagnosisCounts.volume + diagnosisCounts.relevance;
                html += '<div class="alert-card alert-card--info"><span class="alert-card__icon alert-card__icon--info">&#9673;</span><span>';
                html += '<strong>' + stuckCount + '</strong> stuck roles flagged across ' + weeks.length + ' weeks. ';
                if (totalDiag > 0) {
                    var volPct = Math.round(diagnosisCounts.volume / totalDiag * 100);
                    var relPct = 100 - volPct;
                    html += 'Diagnosis split: <strong>' + volPct + '% Volume</strong> / <strong>' + relPct + '% Relevance</strong>. ';
                    if (volPct > 65) html += 'Mostly a sourcing capacity problem — review Stage 4.';
                    else if (relPct > 65) html += 'Mostly a candidate quality problem — review Stage 1 and Stage 6.';
                    else html += 'Mixed problem — both sourcing and screening need attention.';
                }
                html += '</span></div>';
            }

            // Top recurring blockers
            var blockerList = Object.keys(blockerCounts).map(function(k) { return { text: k, count: blockerCounts[k] }; });
            blockerList.sort(function(a, b) { return b.count - a.count; });
            var recurring = blockerList.filter(function(b) { return b.count >= 2; });

            if (recurring.length > 0) {
                html += '<p style="font-size:var(--font-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin:var(--space-4) 0 var(--space-2);font-weight:var(--weight-semibold);">Recurring Blockers (2+ weeks)</p>';
                html += '<ul class="pattern-list">';
                recurring.slice(0, 8).forEach(function(b) {
                    html += '<li><span class="pattern-count">' + b.count + 'x</span> ' + esc(b.text) + '</li>';
                });
                html += '</ul>';
            }

            // Recent wins for team learning
            var winList = Object.keys(winThemes).map(function(k) { return { text: k, count: winThemes[k] }; });
            if (winList.length > 0) {
                html += '<p style="font-size:var(--font-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin:var(--space-4) 0 var(--space-2);font-weight:var(--weight-semibold);">Recent Friday Wins</p>';
                html += '<ul class="pattern-list">';
                winList.slice(0, 5).forEach(function(w) {
                    html += '<li><span class="pattern-count" style="background:rgba(52,211,153,0.1);color:var(--signal-strong);">W</span> ' + esc(w.text) + '</li>';
                });
                html += '</ul>';
            }

            // Recent misses for team learning
            var missList = Object.keys(missThemes).map(function(k) { return { text: k, count: missThemes[k] }; });
            if (missList.length > 0) {
                html += '<p style="font-size:var(--font-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin:var(--space-4) 0 var(--space-2);font-weight:var(--weight-semibold);">Recent Friday Misses</p>';
                html += '<ul class="pattern-list">';
                missList.slice(0, 5).forEach(function(m) {
                    html += '<li><span class="pattern-count" style="background:rgba(248,113,113,0.1);color:var(--signal-risk);">M</span> ' + esc(m.text) + '</li>';
                });
                html += '</ul>';
            }

            if (html === '') {
                html = '<div class="alert-card alert-card--info"><span class="alert-card__icon alert-card__icon--info">i</span><span>Not enough ritual data yet to detect patterns. Keep logging rituals each week.</span></div>';
            }

            document.getElementById('teamPatterns').innerHTML = html;
        }

        function renderTeamOutcomes(teamMap, teams) {
            var html = '';
            var rows = teams.map(function(team) {
                var stats = calcStats(teamMap[team]);
                return { team: team, stats: stats };
            }).filter(function(r) { return r.stats.totalCpSent > 0; });

            if (rows.length === 0) {
                html = '<div class="alert-card alert-card--info"><span class="alert-card__icon alert-card__icon--info">i</span><span>No outcome data logged yet. Use the Outcome Tracking section in the Log Entry tab to track CP→Interview→Offer conversion by team.</span></div>';
                document.getElementById('teamOutcomes').innerHTML = html;
                return;
            }

            html += '<table class="team-compare-table"><thead><tr><th>Team</th><th>CPs Sent</th><th>Interviews</th><th>CP→Int %</th><th>AI CPs</th><th>AI Interviews</th><th>AI CP→Int %</th><th>Audit Packs</th><th>Audit Trace %</th><th>Offers</th><th>Accepted</th><th>Accept %</th><th>TC Done</th><th>TC Stopped</th></tr></thead><tbody>';
            rows.forEach(function(r) {
                var s = r.stats;
                html += '<tr>';
                html += '<td><strong>' + esc(r.team) + '</strong></td>';
                html += '<td>' + s.totalCpSent + '</td>';
                html += '<td>' + s.totalCpInterviews + '</td>';
                html += '<td>' + fmt(s.cpConversion, '%') + '</td>';
                html += '<td>' + s.totalAiCpSent + '</td>';
                html += '<td>' + s.totalAiCpInterviews + '</td>';
                html += '<td>' + fmt(s.aiCpConversion, '%') + '</td>';
                html += '<td>' + s.totalAuditReviewed + '</td>';
                html += '<td>' + fmt(s.avgAuditTraceability, '%') + '</td>';
                html += '<td>' + s.totalOffers + '</td>';
                html += '<td>' + s.totalAccepted + '</td>';
                html += '<td>' + fmt(s.offerAcceptRate, '%') + '</td>';
                html += '<td>' + s.totalTcDone + '</td>';
                html += '<td>' + s.totalTcNoGo + '</td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('teamOutcomes').innerHTML = html;
        }

        function renderTeamCompareChart(teamMap, teams) {
            if (teams.length < 2) { destroyChart('chartTeamCompare'); return; }
            var teamStats = teams.map(function(t) { return { team: t, stats: calcStats(teamMap[t]) }; });
            destroyChart('chartTeamCompare');
            var ctx = document.getElementById('chartTeamCompare').getContext('2d');
            chartInstances['chartTeamCompare'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: teams.map(function(t) { return t.length > 12 ? t.substring(0, 12) + '..' : t; }),
                    datasets: [
                        { label: 'HM Reject %', data: teamStats.map(function(t) { return t.stats.avgHmReject; }), backgroundColor: 'rgba(248,113,113,0.6)', borderRadius: 4 },
                        { label: 'Reply Rate %', data: teamStats.map(function(t) { return t.stats.avgReply; }), backgroundColor: 'rgba(0,229,255,0.6)', borderRadius: 4 },
                        { label: 'TC Catch %', data: teamStats.map(function(t) { return t.stats.avgTcCatch; }), backgroundColor: 'rgba(52,211,153,0.6)', borderRadius: 4 }
                    ]
                },
                options: chartOpts('Comparison across teams')
            });
        }

        function renderTeamOutcomesChart(teamMap, teams) {
            var teamsWithOutcomes = teams.filter(function(t) { return calcStats(teamMap[t]).totalCpSent > 0; });
            if (teamsWithOutcomes.length < 1) { destroyChart('chartTeamOutcomes'); return; }
            var teamStats = teamsWithOutcomes.map(function(t) { return { team: t, stats: calcStats(teamMap[t]) }; });
            destroyChart('chartTeamOutcomes');
            var ctx = document.getElementById('chartTeamOutcomes').getContext('2d');
            chartInstances['chartTeamOutcomes'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: teamsWithOutcomes.map(function(t) { return t.length > 12 ? t.substring(0, 12) + '..' : t; }),
                    datasets: [
                        { label: 'CP→Interview %', data: teamStats.map(function(t) { return t.stats.cpConversion; }), backgroundColor: 'rgba(167,139,250,0.6)', borderRadius: 4 },
                        { label: 'Offer Accept %', data: teamStats.map(function(t) { return t.stats.offerAcceptRate; }), backgroundColor: 'rgba(251,191,36,0.6)', borderRadius: 4 }
                    ]
                },
                options: chartOpts('Outcome conversion by team')
            });
        }

        /* --- Export CSV --- */
        document.getElementById('exportLog').addEventListener('click', function() {
            var entries = getEntries();
            if (entries.length === 0) { showToast('No entries to export'); return; }
            var headers = 'Period,Team,HM Reject %,TTS (days),TC Catch %,Reply Rate %,CPs Sent,CP Interviews,Offers,Accepted,TC Done,TC No-Go,Angle A %,Angle B %,Angle C %,Assets,AI Hours,AI Prompts Used,AI Assets Applied,AI CP Sent,AI CP Interviews,AI Prompt Refs,AI Asset Refs,Audit Packs Reviewed,Audit Traceability %,Audit Consistency %,Audit Risk Tendency,Audit Notes,Decline Comp,Decline Location,Decline Timing,Decline Counter,Decline Mismatch,Decline Other,Notes\n';
            var rows = entries.map(function(e) {
                var d = e.declines || {};
                var o = e.outcomes || {};
                var ai = e.aiUsage || {};
                var audit = e.audit || {};
                var promptRefs = (ai.promptRefs || []).join('|');
                var assetRefs = (ai.assetRefs || []).join('|');
                return [e.period, e.team, e.hmReject, e.tts, e.tcCatch, e.replyRate, o.cpSent, o.cpInterviews, o.offers, o.accepted, o.tcDone, o.tcNoGo, e.angleA, e.angleB, e.angleC, e.assets, ai.hours, ai.promptsUsed, ai.assetsApplied, ai.cpSent, ai.cpInterviews, '"' + promptRefs.replace(/"/g, '""') + '"', '"' + assetRefs.replace(/"/g, '""') + '"', audit.reviewed, audit.traceability, audit.calibration, audit.riskTendency, '"' + String(audit.notes || '').replace(/"/g, '""') + '"', d.compensation, d.location, d.timing, d.counter, d.mismatch, d.other, '"' + (e.notes || '').replace(/"/g, '""') + '"'].join(',');
            }).join('\n');
            var csv = headers + rows;
            if (window.ExportUtils) {
                ExportUtils.downloadFile('telemetry-export.csv', csv, 'text/csv');
            } else {
                var blob = new Blob([csv], { type: 'text/csv' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a'); a.href = url; a.download = 'telemetry-export.csv'; a.click();
                URL.revokeObjectURL(url);
            }
            showToast('CSV exported');
        });

        /* --- Helpers --- */
        function fmt(v, suffix) {
            if (v === null || v === undefined) return '-';
            return Math.round(v * 10) / 10 + (suffix || '');
        }
        function avg(arr) {
            if (!arr.length) return 0;
            return arr.reduce(function(a, b) { return a + b; }, 0) / arr.length;
        }
        function esc(s) {
            if (!s) return '';
            var d = document.createElement('div'); d.textContent = s; return d.innerHTML;
        }
        function showToast(msg) {
            var t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(function() { t.classList.remove('show'); }, 2000);
        }

        /* --- Init --- */
        renderLog();
        renderAutopsyLog();
        // Set default period to current week
        var now = new Date();
        var year = now.getFullYear();
        var week = getWeekNumber(now);
        document.getElementById('entryPeriod').value = year + '-W' + String(week).padStart(2, '0');

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
    })();
    </script>
</body>
</html>
