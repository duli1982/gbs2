<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Telemetry | AI Hub v2.0 — The Confidence Engine | Randstad GBS</title>

    <meta name="description" content="Telemetry — Track recruiting metrics, identify bottlenecks, and measure AI impact across the pipeline.">
    <meta name="author" content="Randstad GBS">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Design System -->
    <link rel="stylesheet" href="../shared/theme.css">
    <link rel="stylesheet" href="../shared/sidebar.css">
    <link rel="stylesheet" href="../shared/v2-buttons.css">
    <link rel="stylesheet" href="../shared/v2-cards.css">

    <style>
        .tel-header { margin-bottom: var(--space-8); }
        .tel-header__label { font-size: var(--font-sm); color: var(--text-muted); font-weight: var(--weight-medium); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: var(--space-2); }
        .tel-header__title { font-size: var(--font-4xl); font-weight: var(--weight-bold); color: var(--text-primary); letter-spacing: -0.02em; }
        .tel-header__title span { color: var(--accent-cyan); }
        .tel-header__subtitle { font-size: var(--font-base); color: var(--text-secondary); margin-top: var(--space-2); max-width: 640px; line-height: 1.6; }

        /* Tabs */
        .tel-tabs { display: flex; gap: var(--space-1); border-bottom: 1px solid var(--border-subtle); margin-bottom: var(--space-8); }
        .tel-tab { padding: var(--space-3) var(--space-5); font-size: var(--font-sm); font-weight: var(--weight-medium); color: var(--text-muted); background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; transition: all var(--transition-fast); font-family: inherit; }
        .tel-tab:hover { color: var(--text-secondary); }
        .tel-tab.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeInUp 0.3s ease both; }

        /* Entry Form */
        .entry-form { max-width: 680px; }
        .form-section { margin-bottom: var(--space-8); }
        .form-section__title { font-size: var(--font-base); font-weight: var(--weight-semibold); color: var(--text-primary); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2); }
        .form-section__title svg { width: 16px; height: 16px; color: var(--accent-cyan); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); }
        .form-group { display: flex; flex-direction: column; gap: var(--space-2); }
        .form-group--full { grid-column: 1 / -1; }
        .form-label { font-size: var(--font-sm); color: var(--text-secondary); font-weight: var(--weight-medium); }
        .form-hint { font-size: var(--font-xs); color: var(--text-muted); }
        .form-input, .form-select, .form-textarea { padding: 10px 14px; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); color: var(--text-primary); font-size: var(--font-sm); font-family: inherit; outline: none; transition: border-color var(--transition-fast); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent-cyan); }
        .form-input::placeholder, .form-textarea::placeholder { color: var(--text-muted); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-select { cursor: pointer; }
        .form-row { display: flex; gap: var(--space-3); align-items: flex-end; }
        .form-actions { display: flex; gap: var(--space-3); margin-top: var(--space-6); }
        .btn-primary { padding: 10px 24px; background: var(--accent-cyan); color: var(--bg-primary); border: none; border-radius: var(--radius-md); font-size: var(--font-sm); font-weight: var(--weight-semibold); cursor: pointer; font-family: inherit; transition: opacity var(--transition-fast); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { padding: 10px 24px; background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); font-size: var(--font-sm); font-weight: var(--weight-medium); cursor: pointer; font-family: inherit; transition: all var(--transition-fast); }
        .btn-secondary:hover { color: var(--text-primary); border-color: var(--border-default); }

        /* Dashboard */
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-8); }
        .stat-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: var(--space-5); text-align: center; }
        .stat-card__value { font-size: var(--font-3xl); font-weight: var(--weight-bold); color: var(--text-primary); font-family: var(--font-mono); }
        .stat-card__label { font-size: var(--font-xs); color: var(--text-muted); margin-top: var(--space-1); text-transform: uppercase; letter-spacing: 0.06em; }
        .stat-card__trend { font-size: var(--font-xs); margin-top: var(--space-2); font-weight: var(--weight-medium); }
        .stat-card__trend--up { color: var(--signal-strong); }
        .stat-card__trend--down { color: var(--signal-risk); }
        .stat-card__trend--flat { color: var(--text-muted); }

        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6); margin-bottom: var(--space-8); }
        .chart-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: var(--space-5); }
        .chart-card__title { font-size: var(--font-sm); font-weight: var(--weight-semibold); color: var(--text-primary); margin-bottom: var(--space-4); }
        .chart-card canvas { width: 100% !important; max-height: 280px; }

        /* Autopsy */
        .autopsy-section { max-width: 720px; }
        .autopsy-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: var(--space-6); margin-bottom: var(--space-6); }
        .autopsy-card__title { font-size: var(--font-base); font-weight: var(--weight-semibold); color: var(--text-primary); margin-bottom: var(--space-4); }

        /* Data Log */
        .data-log { margin-top: var(--space-8); }
        .data-log__title { font-size: var(--font-sm); font-weight: var(--weight-semibold); color: var(--text-primary); margin-bottom: var(--space-4); display: flex; align-items: center; justify-content: space-between; }
        .log-table { width: 100%; border-collapse: collapse; }
        .log-table th, .log-table td { padding: var(--space-2) var(--space-3); text-align: left; font-size: var(--font-sm); border-bottom: 1px solid var(--border-subtle); }
        .log-table th { color: var(--text-muted); font-weight: var(--weight-medium); font-size: var(--font-xs); text-transform: uppercase; letter-spacing: 0.04em; }
        .log-table td { color: var(--text-secondary); }
        .log-table tr:last-child td { border-bottom: none; }
        .log-empty { text-align: center; padding: var(--space-8); color: var(--text-muted); font-size: var(--font-sm); }

        /* Period selector */
        .period-select { display: flex; gap: var(--space-2); margin-bottom: var(--space-6); }
        .period-btn { padding: 6px 14px; font-size: var(--font-xs); font-weight: var(--weight-medium); color: var(--text-muted); background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-full); cursor: pointer; font-family: inherit; transition: all var(--transition-fast); }
        .period-btn:hover { color: var(--text-secondary); border-color: var(--border-default); }
        .period-btn.active { color: var(--accent-cyan); border-color: var(--accent-cyan); background: rgba(0,229,255,0.08); }

        /* Toast */
        .toast { position: fixed; bottom: var(--space-6); right: var(--space-6); padding: var(--space-3) var(--space-5); background: var(--signal-strong); color: var(--bg-primary); border-radius: var(--radius-md); font-size: var(--font-sm); font-weight: var(--weight-medium); z-index: 1100; animation: fadeInUp 0.2s ease; display: none; }
        .toast.show { display: block; }

        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .dashboard-stats { grid-template-columns: 1fr 1fr; }
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body>
    <div class="app-layout">
        <main class="app-main">
            <div class="content-container">

                <header class="tel-header fade-in-up">
                    <div class="tel-header__label">AI Hub v2.0</div>
                    <h1 class="tel-header__title"><span>Telemetry</span></h1>
                    <p class="tel-header__subtitle">Track recruiting metrics manually. Identify bottlenecks. Measure the impact of AI-powered workflows across the pipeline.</p>
                </header>

                <div class="tel-tabs" role="tablist">
                    <button class="tel-tab active" data-tab="entry" role="tab">Log Entry</button>
                    <button class="tel-tab" data-tab="dashboard" role="tab">Dashboard</button>
                    <button class="tel-tab" data-tab="autopsy" role="tab">Monthly Autopsy</button>
                </div>

                <!-- TAB: Log Entry -->
                <div class="tab-panel active" id="tab-entry">
                    <form class="entry-form" id="entryForm" autocomplete="off">
                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                Entry Details
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Period</label>
                                    <input type="week" class="form-input" id="entryPeriod" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Market / Team</label>
                                    <input type="text" class="form-input" id="entryTeam" placeholder="e.g., EMEA North">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                Pipeline Metrics
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">HM Rejection Rate</label>
                                    <input type="number" class="form-input" id="metricHmReject" min="0" max="100" step="1" placeholder="% of submissions rejected">
                                    <span class="form-hint">% of Confidence Packs rejected by hiring managers</span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Time-to-Shortlist (days)</label>
                                    <input type="number" class="form-input" id="metricTts" min="0" step="0.5" placeholder="Avg days from intake to shortlist">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Truth Check Catch Rate</label>
                                    <input type="number" class="form-input" id="metricTcCatch" min="0" max="100" step="1" placeholder="% flagged as Risk">
                                    <span class="form-hint">% of candidates flagged as Risk during Truth Check</span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Outreach Reply Rate</label>
                                    <input type="number" class="form-input" id="metricReplyRate" min="0" max="100" step="1" placeholder="% responded to first touch">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                                Outreach by Angle
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Angle A: Mission</label>
                                    <input type="number" class="form-input" id="angleA" min="0" max="100" step="1" placeholder="Reply rate %">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Angle B: Craft</label>
                                    <input type="number" class="form-input" id="angleB" min="0" max="100" step="1" placeholder="Reply rate %">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Angle C: Career</label>
                                    <input type="number" class="form-input" id="angleC" min="0" max="100" step="1" placeholder="Reply rate %">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Assets Created</label>
                                    <input type="number" class="form-input" id="metricAssets" min="0" step="1" placeholder="New assets this period">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section__title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                                Decline Reasons (count this period)
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Compensation</label>
                                    <input type="number" class="form-input" id="declineComp" min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Location</label>
                                    <input type="number" class="form-input" id="declineLocation" min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Timing / Notice</label>
                                    <input type="number" class="form-input" id="declineTiming" min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Counter-offer / Stayed</label>
                                    <input type="number" class="form-input" id="declineCounter" min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Role Mismatch</label>
                                    <input type="number" class="form-input" id="declineMismatch" min="0" step="1" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Other</label>
                                    <input type="number" class="form-input" id="declineOther" min="0" step="1" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-group form-group--full">
                                <label class="form-label">Notes (optional)</label>
                                <textarea class="form-textarea" id="entryNotes" placeholder="Any context, observations, or anomalies this period..."></textarea>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Save Entry</button>
                            <button type="reset" class="btn-secondary">Clear</button>
                        </div>
                    </form>

                    <!-- Data Log -->
                    <div class="data-log">
                        <div class="data-log__title">
                            <span>Recent Entries</span>
                            <button class="btn-secondary" id="exportLog" style="padding: 4px 12px; font-size: var(--font-xs);">Export CSV</button>
                        </div>
                        <div id="logTable"></div>
                    </div>
                </div>

                <!-- TAB: Dashboard -->
                <div class="tab-panel" id="tab-dashboard">
                    <div class="period-select" id="periodSelect">
                        <button class="period-btn active" data-range="4">Last 4 Weeks</button>
                        <button class="period-btn" data-range="8">Last 8 Weeks</button>
                        <button class="period-btn" data-range="12">Last 12 Weeks</button>
                        <button class="period-btn" data-range="0">All Time</button>
                    </div>

                    <div class="dashboard-stats" id="dashStats"></div>

                    <div class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-card__title">Pipeline Metrics Trend</div>
                            <canvas id="chartTrend"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card__title">Outreach by Angle</div>
                            <canvas id="chartAngles"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card__title">Decline Reasons</div>
                            <canvas id="chartDeclines"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card__title">Stage Bottlenecks</div>
                            <canvas id="chartBottlenecks"></canvas>
                        </div>
                    </div>
                </div>

                <!-- TAB: Monthly Autopsy -->
                <div class="tab-panel" id="tab-autopsy">
                    <div class="autopsy-section">
                        <div class="autopsy-card">
                            <div class="autopsy-card__title">Month</div>
                            <input type="month" class="form-input" id="autopsyMonth" style="max-width: 220px;">
                        </div>

                        <div class="autopsy-card">
                            <div class="autopsy-card__title">What Worked</div>
                            <textarea class="form-textarea" id="autopsyWorked" rows="4" placeholder="Processes, tools, or approaches that delivered results this month..."></textarea>
                        </div>

                        <div class="autopsy-card">
                            <div class="autopsy-card__title">What Didn't</div>
                            <textarea class="form-textarea" id="autopsyFailed" rows="4" placeholder="What underperformed, caused friction, or wasted time..."></textarea>
                        </div>

                        <div class="autopsy-card">
                            <div class="autopsy-card__title">Root Causes</div>
                            <textarea class="form-textarea" id="autopsyRoot" rows="4" placeholder="Why did the failures happen? Volume problem? Relevance problem? Process gap?"></textarea>
                        </div>

                        <div class="autopsy-card">
                            <div class="autopsy-card__title">Actions for Next Month</div>
                            <textarea class="form-textarea" id="autopsyActions" rows="4" placeholder="Specific changes to implement. Who does what, by when..."></textarea>
                        </div>

                        <div class="autopsy-card">
                            <div class="autopsy-card__title">Data Summary (auto-filled from entries)</div>
                            <div id="autopsySummary" style="font-size: var(--font-sm); color: var(--text-secondary); line-height: 1.6;">Select a month above to see aggregated metrics.</div>
                        </div>

                        <div class="form-actions">
                            <button class="btn-primary" id="saveAutopsy">Save Autopsy</button>
                            <button class="btn-secondary" id="printAutopsy">Print</button>
                        </div>

                        <!-- Past Autopsies -->
                        <div class="data-log" style="margin-top: var(--space-10);">
                            <div class="data-log__title"><span>Past Autopsies</span></div>
                            <div id="autopsyLog"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div class="toast" id="toast"></div>

    <script src="../shared/sidebar.js"></script>
    <script src="../shared/v2-footer.js"></script>
    <script src="../shared/export-utils.js"></script>
    <script>
    (function() {
        'use strict';

        var STORAGE_KEY = 'telemetry-entries';
        var AUTOPSY_KEY = 'telemetry-autopsies';
        var chartInstances = {};
        var dashRange = 4;

        /* --- Tab Switching --- */
        document.querySelectorAll('.tel-tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tel-tab').forEach(function(t) { t.classList.remove('active'); });
                document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
                this.classList.add('active');
                document.getElementById('tab-' + this.dataset.tab).classList.add('active');
                if (this.dataset.tab === 'dashboard') renderDashboard();
            });
        });

        /* --- Storage --- */
        function getEntries() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch(e) { return []; }
        }
        function saveEntries(entries) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        }
        function getAutopsies() {
            try { return JSON.parse(localStorage.getItem(AUTOPSY_KEY)) || []; } catch(e) { return []; }
        }
        function saveAutopsies(list) {
            localStorage.setItem(AUTOPSY_KEY, JSON.stringify(list));
        }

        /* --- Form Submit --- */
        document.getElementById('entryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var entry = {
                id: Date.now(),
                period: document.getElementById('entryPeriod').value,
                team: document.getElementById('entryTeam').value,
                hmReject: parseNum('metricHmReject'),
                tts: parseNum('metricTts'),
                tcCatch: parseNum('metricTcCatch'),
                replyRate: parseNum('metricReplyRate'),
                angleA: parseNum('angleA'),
                angleB: parseNum('angleB'),
                angleC: parseNum('angleC'),
                assets: parseNum('metricAssets'),
                declines: {
                    compensation: parseNum('declineComp'),
                    location: parseNum('declineLocation'),
                    timing: parseNum('declineTiming'),
                    counter: parseNum('declineCounter'),
                    mismatch: parseNum('declineMismatch'),
                    other: parseNum('declineOther')
                },
                notes: document.getElementById('entryNotes').value,
                createdAt: new Date().toISOString()
            };
            var entries = getEntries();
            entries.unshift(entry);
            saveEntries(entries);
            this.reset();
            renderLog();
            showToast('Entry saved');
        });

        function parseNum(id) {
            var v = document.getElementById(id).value;
            return v === '' ? null : parseFloat(v);
        }

        /* --- Log Table --- */
        function renderLog() {
            var entries = getEntries();
            var container = document.getElementById('logTable');
            if (entries.length === 0) {
                container.innerHTML = '<div class="log-empty">No entries yet. Submit your first weekly metrics above.</div>';
                return;
            }
            var html = '<table class="log-table"><thead><tr><th>Period</th><th>Team</th><th>HM Rej %</th><th>TTS</th><th>TC Catch</th><th>Reply %</th><th>Assets</th><th></th></tr></thead><tbody>';
            entries.slice(0, 20).forEach(function(e) {
                html += '<tr>';
                html += '<td>' + esc(e.period) + '</td>';
                html += '<td>' + esc(e.team || '-') + '</td>';
                html += '<td>' + fmt(e.hmReject, '%') + '</td>';
                html += '<td>' + fmt(e.tts, 'd') + '</td>';
                html += '<td>' + fmt(e.tcCatch, '%') + '</td>';
                html += '<td>' + fmt(e.replyRate, '%') + '</td>';
                html += '<td>' + fmt(e.assets) + '</td>';
                html += '<td><button class="btn-secondary" style="padding:2px 8px;font-size:11px;" data-delete="' + e.id + '">Del</button></td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;

            container.querySelectorAll('[data-delete]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var id = parseInt(this.dataset.delete);
                    var entries = getEntries().filter(function(e) { return e.id !== id; });
                    saveEntries(entries);
                    renderLog();
                });
            });
        }

        /* --- Dashboard --- */
        function renderDashboard() {
            var entries = getEntries();
            if (dashRange > 0) entries = entries.slice(0, dashRange);

            // Stats
            var stats = calcStats(entries);
            var statsHtml = '';
            var statItems = [
                { label: 'Avg HM Rejection', value: stats.avgHmReject, unit: '%', good: 'low' },
                { label: 'Avg Time-to-Shortlist', value: stats.avgTts, unit: 'd', good: 'low' },
                { label: 'Avg TC Catch Rate', value: stats.avgTcCatch, unit: '%', good: null },
                { label: 'Avg Reply Rate', value: stats.avgReply, unit: '%', good: 'high' },
                { label: 'Total Assets Created', value: stats.totalAssets, unit: '', good: 'high' },
                { label: 'Total Entries', value: entries.length, unit: '', good: null }
            ];
            statItems.forEach(function(s) {
                statsHtml += '<div class="stat-card">';
                statsHtml += '<div class="stat-card__value">' + (s.value !== null ? (Math.round(s.value * 10) / 10) + s.unit : '-') + '</div>';
                statsHtml += '<div class="stat-card__label">' + s.label + '</div>';
                statsHtml += '</div>';
            });
            document.getElementById('dashStats').innerHTML = statsHtml;

            // Charts
            renderTrendChart(entries);
            renderAnglesChart(entries);
            renderDeclinesChart(entries);
            renderBottlenecksChart(stats);
        }

        function calcStats(entries) {
            var s = { avgHmReject: null, avgTts: null, avgTcCatch: null, avgReply: null, totalAssets: 0 };
            if (entries.length === 0) return s;
            var sums = { hm: 0, hmC: 0, tts: 0, ttsC: 0, tc: 0, tcC: 0, rr: 0, rrC: 0 };
            entries.forEach(function(e) {
                if (e.hmReject !== null) { sums.hm += e.hmReject; sums.hmC++; }
                if (e.tts !== null) { sums.tts += e.tts; sums.ttsC++; }
                if (e.tcCatch !== null) { sums.tc += e.tcCatch; sums.tcC++; }
                if (e.replyRate !== null) { sums.rr += e.replyRate; sums.rrC++; }
                if (e.assets !== null) s.totalAssets += e.assets;
            });
            if (sums.hmC) s.avgHmReject = sums.hm / sums.hmC;
            if (sums.ttsC) s.avgTts = sums.tts / sums.ttsC;
            if (sums.tcC) s.avgTcCatch = sums.tc / sums.tcC;
            if (sums.rrC) s.avgReply = sums.rr / sums.rrC;
            return s;
        }

        function renderTrendChart(entries) {
            var reversed = entries.slice().reverse();
            var labels = reversed.map(function(e) { return e.period; });
            destroyChart('chartTrend');
            var ctx = document.getElementById('chartTrend').getContext('2d');
            chartInstances['chartTrend'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'HM Reject %', data: reversed.map(function(e) { return e.hmReject; }), borderColor: '#f87171', tension: 0.3, pointRadius: 3 },
                        { label: 'Reply Rate %', data: reversed.map(function(e) { return e.replyRate; }), borderColor: '#00e5ff', tension: 0.3, pointRadius: 3 },
                        { label: 'TC Catch %', data: reversed.map(function(e) { return e.tcCatch; }), borderColor: '#34d399', tension: 0.3, pointRadius: 3 }
                    ]
                },
                options: chartOpts('Trend over time')
            });
        }

        function renderAnglesChart(entries) {
            var totals = { a: [], b: [], c: [] };
            entries.forEach(function(e) {
                if (e.angleA !== null) totals.a.push(e.angleA);
                if (e.angleB !== null) totals.b.push(e.angleB);
                if (e.angleC !== null) totals.c.push(e.angleC);
            });
            destroyChart('chartAngles');
            var ctx = document.getElementById('chartAngles').getContext('2d');
            chartInstances['chartAngles'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mission (A)', 'Craft (B)', 'Career (C)'],
                    datasets: [{
                        label: 'Avg Reply Rate %',
                        data: [avg(totals.a), avg(totals.b), avg(totals.c)],
                        backgroundColor: ['rgba(244,114,182,0.7)', 'rgba(167,139,250,0.7)', 'rgba(251,191,36,0.7)'],
                        borderRadius: 6
                    }]
                },
                options: chartOpts('Average reply rate by outreach angle')
            });
        }

        function renderDeclinesChart(entries) {
            var totals = { compensation: 0, location: 0, timing: 0, counter: 0, mismatch: 0, other: 0 };
            entries.forEach(function(e) {
                if (!e.declines) return;
                Object.keys(totals).forEach(function(k) {
                    totals[k] += (e.declines[k] || 0);
                });
            });
            destroyChart('chartDeclines');
            var ctx = document.getElementById('chartDeclines').getContext('2d');
            chartInstances['chartDeclines'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Compensation', 'Location', 'Timing', 'Counter-offer', 'Mismatch', 'Other'],
                    datasets: [{
                        data: Object.values(totals),
                        backgroundColor: ['#f87171', '#60a5fa', '#fbbf24', '#c084fc', '#fb923c', '#6b7280'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#a1a1b5', font: { size: 11 }, padding: 12 } }
                    }
                }
            });
        }

        function renderBottlenecksChart(stats) {
            destroyChart('chartBottlenecks');
            var ctx = document.getElementById('chartBottlenecks').getContext('2d');
            chartInstances['chartBottlenecks'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['HM Rejection', 'Time-to-Shortlist', 'TC Catch Rate', 'Reply Rate'],
                    datasets: [{
                        label: 'Current Average',
                        data: [
                            stats.avgHmReject || 0,
                            stats.avgTts ? Math.min(stats.avgTts * 5, 100) : 0,
                            stats.avgTcCatch || 0,
                            100 - (stats.avgReply || 0)
                        ],
                        backgroundColor: function(ctx) {
                            var v = ctx.raw;
                            return v > 60 ? 'rgba(248,113,113,0.7)' : v > 30 ? 'rgba(251,191,36,0.7)' : 'rgba(52,211,153,0.7)';
                        },
                        borderRadius: 6
                    }]
                },
                options: chartOpts('Higher = more friction (bottleneck)')
            });
        }

        function chartOpts(subtitle) {
            return {
                responsive: true,
                scales: {
                    x: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                    y: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.06)' }, beginAtZero: true }
                },
                plugins: {
                    legend: { labels: { color: '#a1a1b5', font: { size: 11 }, padding: 10 } },
                    tooltip: { backgroundColor: '#1a1c23', titleColor: '#fff', bodyColor: '#d1d5db', borderColor: '#2a2d37', borderWidth: 1 }
                }
            };
        }

        function destroyChart(id) {
            if (chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; }
        }

        /* --- Period Select --- */
        document.getElementById('periodSelect').addEventListener('click', function(e) {
            var btn = e.target.closest('.period-btn');
            if (!btn) return;
            this.querySelectorAll('.period-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            dashRange = parseInt(btn.dataset.range);
            renderDashboard();
        });

        /* --- Autopsy --- */
        document.getElementById('autopsyMonth').addEventListener('change', function() {
            var month = this.value;
            if (!month) return;
            var entries = getEntries().filter(function(e) {
                return e.period && e.period.substring(0, 7) === month;
            });
            var stats = calcStats(entries);
            var html = '<p><strong>' + entries.length + '</strong> entries for ' + month + '</p>';
            if (entries.length > 0) {
                html += '<p>Avg HM Rejection: <strong>' + fmt(stats.avgHmReject, '%') + '</strong></p>';
                html += '<p>Avg Time-to-Shortlist: <strong>' + fmt(stats.avgTts, 'd') + '</strong></p>';
                html += '<p>Avg TC Catch Rate: <strong>' + fmt(stats.avgTcCatch, '%') + '</strong></p>';
                html += '<p>Avg Reply Rate: <strong>' + fmt(stats.avgReply, '%') + '</strong></p>';
                html += '<p>Assets Created: <strong>' + stats.totalAssets + '</strong></p>';
            }
            document.getElementById('autopsySummary').innerHTML = html;

            // Load existing autopsy
            var autopsies = getAutopsies();
            var existing = autopsies.find(function(a) { return a.month === month; });
            if (existing) {
                document.getElementById('autopsyWorked').value = existing.worked || '';
                document.getElementById('autopsyFailed').value = existing.failed || '';
                document.getElementById('autopsyRoot').value = existing.root || '';
                document.getElementById('autopsyActions').value = existing.actions || '';
            }
        });

        document.getElementById('saveAutopsy').addEventListener('click', function() {
            var month = document.getElementById('autopsyMonth').value;
            if (!month) { showToast('Select a month first'); return; }
            var autopsy = {
                month: month,
                worked: document.getElementById('autopsyWorked').value,
                failed: document.getElementById('autopsyFailed').value,
                root: document.getElementById('autopsyRoot').value,
                actions: document.getElementById('autopsyActions').value,
                savedAt: new Date().toISOString()
            };
            var list = getAutopsies();
            var idx = list.findIndex(function(a) { return a.month === month; });
            if (idx >= 0) list[idx] = autopsy; else list.unshift(autopsy);
            saveAutopsies(list);
            renderAutopsyLog();
            showToast('Autopsy saved');
        });

        document.getElementById('printAutopsy').addEventListener('click', function() {
            var month = document.getElementById('autopsyMonth').value || 'Unknown';
            var content = '<h2>Monthly Autopsy: ' + month + '</h2>';
            content += '<h3>What Worked</h3><p>' + esc(document.getElementById('autopsyWorked').value) + '</p>';
            content += '<h3>What Didn\'t</h3><p>' + esc(document.getElementById('autopsyFailed').value) + '</p>';
            content += '<h3>Root Causes</h3><p>' + esc(document.getElementById('autopsyRoot').value) + '</p>';
            content += '<h3>Actions</h3><p>' + esc(document.getElementById('autopsyActions').value) + '</p>';
            content += '<h3>Data Summary</h3>' + document.getElementById('autopsySummary').innerHTML;
            if (window.ExportUtils) ExportUtils.printContent('Monthly Autopsy — ' + month, content);
        });

        function renderAutopsyLog() {
            var list = getAutopsies();
            var container = document.getElementById('autopsyLog');
            if (list.length === 0) {
                container.innerHTML = '<div class="log-empty">No autopsies yet.</div>';
                return;
            }
            var html = '<table class="log-table"><thead><tr><th>Month</th><th>Saved</th><th>Actions</th></tr></thead><tbody>';
            list.forEach(function(a) {
                html += '<tr><td>' + esc(a.month) + '</td><td>' + new Date(a.savedAt).toLocaleDateString() + '</td>';
                html += '<td>' + esc((a.actions || '').substring(0, 80)) + (a.actions && a.actions.length > 80 ? '...' : '') + '</td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        /* --- Export CSV --- */
        document.getElementById('exportLog').addEventListener('click', function() {
            var entries = getEntries();
            if (entries.length === 0) { showToast('No entries to export'); return; }
            var headers = 'Period,Team,HM Reject %,TTS (days),TC Catch %,Reply Rate %,Angle A %,Angle B %,Angle C %,Assets,Decline Comp,Decline Location,Decline Timing,Decline Counter,Decline Mismatch,Decline Other,Notes\n';
            var rows = entries.map(function(e) {
                var d = e.declines || {};
                return [e.period, e.team, e.hmReject, e.tts, e.tcCatch, e.replyRate, e.angleA, e.angleB, e.angleC, e.assets, d.compensation, d.location, d.timing, d.counter, d.mismatch, d.other, '"' + (e.notes || '').replace(/"/g, '""') + '"'].join(',');
            }).join('\n');
            var csv = headers + rows;
            if (window.ExportUtils) {
                ExportUtils.downloadFile('telemetry-export.csv', csv, 'text/csv');
            } else {
                var blob = new Blob([csv], { type: 'text/csv' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a'); a.href = url; a.download = 'telemetry-export.csv'; a.click();
                URL.revokeObjectURL(url);
            }
            showToast('CSV exported');
        });

        /* --- Helpers --- */
        function fmt(v, suffix) {
            if (v === null || v === undefined) return '-';
            return Math.round(v * 10) / 10 + (suffix || '');
        }
        function avg(arr) {
            if (!arr.length) return 0;
            return arr.reduce(function(a, b) { return a + b; }, 0) / arr.length;
        }
        function esc(s) {
            if (!s) return '';
            var d = document.createElement('div'); d.textContent = s; return d.innerHTML;
        }
        function showToast(msg) {
            var t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(function() { t.classList.remove('show'); }, 2000);
        }

        /* --- Init --- */
        renderLog();
        renderAutopsyLog();
        // Set default period to current week
        var now = new Date();
        var year = now.getFullYear();
        var week = getWeekNumber(now);
        document.getElementById('entryPeriod').value = year + '-W' + String(week).padStart(2, '0');

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
    })();
    </script>
</body>
</html>
