<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Asset Library | AI Hub v2.0 — The Confidence Engine | Randstad GBS</title>

    <meta name="description" content="Asset Library — Reusable templates, scripts, playbooks, and standards for AI-powered recruiting workflows.">
    <meta name="author" content="Randstad GBS">

    <meta property="og:type" content="website">
    <meta property="og:title" content="Asset Library — AI Hub v2.0">
    <meta property="og:description" content="Searchable repository of recruiting templates and playbooks.">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Design System -->
    <link rel="stylesheet" href="../shared/theme.css">
    <link rel="stylesheet" href="../shared/sidebar.css">
    <link rel="stylesheet" href="../shared/v2-buttons.css">
    <link rel="stylesheet" href="../shared/v2-cards.css">

    <style>
        /* --- Page Header --- */
        .library-header {
            margin-bottom: var(--space-8);
        }

        .library-header__label {
            font-size: var(--font-sm);
            color: var(--text-muted);
            font-weight: var(--weight-medium);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: var(--space-2);
        }

        .library-header__title {
            font-size: var(--font-4xl);
            font-weight: var(--weight-bold);
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .library-header__title span {
            color: var(--accent-cyan);
        }

        .library-header__subtitle {
            font-size: var(--font-base);
            color: var(--text-secondary);
            margin-top: var(--space-2);
            max-width: 640px;
            line-height: 1.6;
        }

        /* --- Toolbar --- */
        .library-toolbar {
            display: flex;
            gap: var(--space-4);
            align-items: center;
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }

        .library-search {
            flex: 1;
            min-width: 240px;
            position: relative;
        }

        .library-search__icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .library-search__input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-sm);
            font-family: inherit;
            outline: none;
            transition: border-color var(--transition-fast);
        }

        .library-search__input::placeholder {
            color: var(--text-muted);
        }

        .library-search__input:focus {
            border-color: var(--accent-cyan);
        }

        .library-sort {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .library-sort__label {
            font-size: var(--font-xs);
            color: var(--text-muted);
            white-space: nowrap;
        }

        .library-sort__select {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-sm);
            font-family: inherit;
            cursor: pointer;
            outline: none;
        }

        .library-sort__select:focus {
            border-color: var(--accent-cyan);
        }

        /* --- Category Filters --- */
        .library-filters {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }

        .filter-pill {
            padding: 6px 14px;
            font-size: var(--font-xs);
            font-weight: var(--weight-medium);
            color: var(--text-muted);
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
            white-space: nowrap;
        }

        .filter-pill:hover {
            color: var(--text-secondary);
            border-color: var(--border-default);
        }

        .filter-pill.active {
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
            background: rgba(0, 229, 255, 0.08);
        }

        .filter-pill__count {
            margin-left: 4px;
            opacity: 0.6;
        }

        /* --- Results Info --- */
        .library-results-info {
            font-size: var(--font-sm);
            color: var(--text-muted);
            margin-bottom: var(--space-4);
        }

        /* --- Asset Grid --- */
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: var(--space-4);
        }

        .asset-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
        }

        .asset-card:hover {
            border-color: var(--border-default);
            transform: translateY(-1px);
        }

        .asset-card__top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .asset-card__category {
            font-size: 10px;
            font-weight: var(--weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            white-space: nowrap;
        }

        .asset-card__category--role-passport { color: #00e5ff; background: rgba(0,229,255,0.1); }
        .asset-card__category--sourcing-plan { color: #a78bfa; background: rgba(167,139,250,0.1); }
        .asset-card__category--truth-check { color: #34d399; background: rgba(52,211,153,0.1); }
        .asset-card__category--confidence-pack { color: #fbbf24; background: rgba(251,191,36,0.1); }
        .asset-card__category--outreach { color: #f472b6; background: rgba(244,114,182,0.1); }
        .asset-card__category--trade-off { color: #fb923c; background: rgba(251,146,60,0.1); }
        .asset-card__category--standards { color: #60a5fa; background: rgba(96,165,250,0.1); }
        .asset-card__category--automation { color: #c084fc; background: rgba(192,132,252,0.1); }

        .asset-card__usage {
            font-size: var(--font-xs);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .asset-card__usage svg {
            width: 12px;
            height: 12px;
        }

        .asset-card__title {
            font-size: var(--font-base);
            font-weight: var(--weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--space-2);
            line-height: 1.3;
        }

        .asset-card__desc {
            font-size: var(--font-sm);
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: var(--space-3);
            flex: 1;
        }

        .asset-card__meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: var(--font-xs);
            color: var(--text-muted);
            padding-top: var(--space-3);
            border-top: 1px solid var(--border-subtle);
        }

        .asset-card__stage {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .asset-card__stage svg {
            width: 12px;
            height: 12px;
            color: var(--accent-cyan);
        }

        /* --- Empty State --- */
        .library-empty {
            text-align: center;
            padding: var(--space-16) var(--space-4);
        }

        .library-empty__icon {
            width: 48px;
            height: 48px;
            color: var(--text-muted);
            margin: 0 auto var(--space-4);
            opacity: 0.5;
        }

        .library-empty__title {
            font-size: var(--font-base);
            font-weight: var(--weight-medium);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .library-empty__text {
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        /* --- Detail Modal --- */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 780px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            animation: fadeInUp 0.2s ease;
        }

        .modal__header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--space-4);
            padding: var(--space-6);
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal__title {
            font-size: var(--font-xl);
            font-weight: var(--weight-bold);
            color: var(--text-primary);
        }

        .modal__close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }

        .modal__close:hover {
            color: var(--text-primary);
            border-color: var(--border-default);
        }

        .modal__close svg {
            width: 16px;
            height: 16px;
        }

        .modal__body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-6);
        }

        .modal__content {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .modal__content h2 {
            font-size: var(--font-lg);
            font-weight: var(--weight-bold);
            color: var(--text-primary);
            margin-top: var(--space-6);
            margin-bottom: var(--space-3);
        }

        .modal__content h2:first-child {
            margin-top: 0;
        }

        .modal__content h3 {
            font-size: var(--font-base);
            font-weight: var(--weight-semibold);
            color: var(--text-primary);
            margin-top: var(--space-5);
            margin-bottom: var(--space-2);
        }

        .modal__content p {
            margin-bottom: var(--space-3);
        }

        .modal__content strong {
            color: var(--text-primary);
            font-weight: var(--weight-semibold);
        }

        .modal__content ul, .modal__content ol {
            padding-left: var(--space-5);
            margin-bottom: var(--space-3);
        }

        .modal__content li {
            margin-bottom: var(--space-2);
        }

        .modal__content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-4);
        }

        .modal__content th, .modal__content td {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border-subtle);
            text-align: left;
            font-size: var(--font-sm);
        }

        .modal__content th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: var(--weight-semibold);
        }

        .modal__footer {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--border-subtle);
        }

        .modal__footer .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: 8px 16px;
            font-size: var(--font-sm);
            font-weight: var(--weight-medium);
            border-radius: var(--radius-md);
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .modal__footer .btn svg {
            width: 14px;
            height: 14px;
        }

        .modal__footer .btn--copy {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
        }

        .modal__footer .btn--copy:hover {
            opacity: 0.9;
        }

        .modal__footer .btn--print {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .modal__footer .btn--print:hover {
            color: var(--text-primary);
            border-color: var(--border-default);
        }

        .modal__footer .btn--download {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .modal__footer .btn--download:hover {
            color: var(--text-primary);
            border-color: var(--border-default);
        }

        /* --- Bottom Link --- */
        .library-bottom {
            margin-top: var(--space-10);
            padding-top: var(--space-6);
            border-top: 1px solid var(--border-subtle);
        }

        .library-bottom a {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-sm);
            color: var(--text-muted);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .library-bottom a:hover {
            color: var(--text-secondary);
        }

        .library-bottom svg {
            width: 14px;
            height: 14px;
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .library-header__title {
                font-size: var(--font-2xl);
            }

            .asset-grid {
                grid-template-columns: 1fr;
            }

            .library-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .modal {
                max-height: 95vh;
            }

            .modal__header {
                padding: var(--space-4);
            }

            .modal__body {
                padding: var(--space-4);
            }

            .modal__footer {
                padding: var(--space-3) var(--space-4);
                flex-wrap: wrap;
            }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <main class="app-main">
            <div class="content-container">

                <!-- Page Header -->
                <header class="library-header fade-in-up">
                    <div class="library-header__label">AI Hub v2.0</div>
                    <h1 class="library-header__title">Asset <span>Library</span></h1>
                    <p class="library-header__subtitle">Reusable templates, scripts, playbooks, and standards. Everything your team needs to execute the AI-powered recruiting workflow.</p>
                </header>

                <!-- Toolbar -->
                <div class="library-toolbar fade-in-up">
                    <div class="library-search">
                        <svg class="library-search__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <input type="text" class="library-search__input" id="searchInput" placeholder="Search templates, scripts, playbooks..." autocomplete="off">
                    </div>
                    <div class="library-sort">
                        <span class="library-sort__label">Sort:</span>
                        <select class="library-sort__select" id="sortSelect">
                            <option value="popular">Most Used</option>
                            <option value="alpha">A-Z</option>
                            <option value="recent">Recently Updated</option>
                        </select>
                    </div>
                </div>

                <!-- Category Filters -->
                <div class="library-filters fade-in-up" id="filterPills"></div>

                <!-- Results Info -->
                <div class="library-results-info" id="resultsInfo"></div>

                <!-- Asset Grid -->
                <div class="asset-grid" id="assetGrid"></div>

                <!-- Empty State -->
                <div class="library-empty" id="emptyState" style="display:none;">
                    <svg class="library-empty__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <div class="library-empty__title">No assets found</div>
                    <div class="library-empty__text">Try a different search term or clear your filters.</div>
                </div>

                <!-- Bottom Link -->
                <div class="library-bottom">
                    <a href="/academy/">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 8 3 12 0v-5"/></svg>
                        Learn how to use these assets in the Academy
                    </a>
                </div>

            </div>
        </main>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" role="dialog" aria-modal="true">
            <div class="modal__header">
                <h2 class="modal__title" id="modalTitle"></h2>
                <button class="modal__close" id="modalClose" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal__body">
                <div class="modal__content" id="modalContent"></div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--copy" id="modalCopy">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    Copy
                </button>
                <button class="btn btn--print" id="modalPrint">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                    Print
                </button>
                <button class="btn btn--download" id="modalDownload">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Download
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../shared/sidebar.js"></script>
    <script src="../shared/v2-footer.js"></script>
    <script src="../shared/export-utils.js"></script>
    <script>
    (function() {
        'use strict';

        var assets = [];
        var activeCategory = 'all';
        var searchQuery = '';
        var sortBy = 'popular';
        var currentAsset = null;
        var searchDebounceTimer = null;

        var SEARCH_STOP_WORDS = new Set([
            'a','an','and','are','as','at','be','by','for','from','how','i','in','is','it',
            'of','on','or','that','the','to','was','what','when','where','which','who','why','with','you','your'
        ]);

        var QUERY_EXPANSIONS = {
            template: ['playbook', 'format', 'guide'],
            sourcing: ['boolean', 'search', 'talent'],
            screen: ['screening', 'truth check', 'rubric'],
            submission: ['confidence pack', 'shortlist'],
            outreach: ['email', 'message', 'engagement'],
            tradeoff: ['trade-off', 'negotiation', 'options'],
            role: ['passport', 'intake', 'requirements']
        };

        var CATEGORIES = {
            'all': 'All',
            'role-passport': 'Role Passport',
            'sourcing-plan': 'Sourcing Plan',
            'truth-check': 'Truth Check',
            'confidence-pack': 'Confidence Pack',
            'outreach': 'Outreach',
            'trade-off': 'Trade-offs',
            'standards': 'Standards',
            'automation': 'Automation'
        };

        function sanitizeSearchInput(value) {
            if (window.SecurityUtils && typeof window.SecurityUtils.sanitizeSearchQuery === 'function') {
                return window.SecurityUtils.sanitizeSearchQuery(value || '');
            }
            return String(value || '')
                .normalize('NFKC')
                .replace(/[\u0000-\u001F\u007F]/g, ' ')
                .replace(/[<>`"'\\]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim()
                .slice(0, 160);
        }

        function tokenize(text) {
            return String(text || '')
                .toLowerCase()
                .replace(/[^a-z0-9\s]+/g, ' ')
                .split(/\s+/)
                .filter(function(token) { return token && token.length > 1; });
        }

        function expandTokens(tokens) {
            var set = new Set(tokens);
            tokens.forEach(function(token) {
                var expansions = QUERY_EXPANSIONS[token];
                if (!expansions) return;
                expansions.forEach(function(term) {
                    tokenize(term).forEach(function(t) { set.add(t); });
                });
            });
            return Array.from(set);
        }

        function buildSearchCycles(query) {
            var clean = sanitizeSearchInput(query).toLowerCase();
            var baseTokens = tokenize(clean).filter(function(token) { return !SEARCH_STOP_WORDS.has(token); });
            var expandedTokens = expandTokens(baseTokens);
            var relaxedTokens = expandedTokens.filter(function(token) { return token.length >= 3; });
            return [
                { name: 'strict', phrase: clean, tokens: baseTokens, minScore: 3 },
                { name: 'expanded', phrase: '', tokens: expandedTokens, minScore: 2 },
                { name: 'relaxed', phrase: '', tokens: relaxedTokens, minScore: 1 }
            ];
        }

        function scoreAsset(asset, cycle) {
            var title = String(asset.title || '').toLowerCase();
            var description = String(asset.description || '').toLowerCase();
            var stageLabel = String(asset.stageLabel || '').toLowerCase();
            var content = String(asset.content || '').toLowerCase();
            var category = String(asset.category || '').toLowerCase();

            var score = 0;
            if (cycle.phrase && cycle.phrase.length >= 4) {
                if (title.indexOf(cycle.phrase) !== -1) score += 9;
                if (description.indexOf(cycle.phrase) !== -1) score += 6;
                if (content.indexOf(cycle.phrase) !== -1) score += 4;
            }

            cycle.tokens.forEach(function(token) {
                if (title.indexOf(token) !== -1) score += 4;
                if (category.indexOf(token) !== -1 || stageLabel.indexOf(token) !== -1) score += 3;
                if (description.indexOf(token) !== -1) score += 2;
                if (content.indexOf(token) !== -1) score += 1;
            });

            return score;
        }

        function rankAssetsByQuery(list, query) {
            var cycles = buildSearchCycles(query).filter(function(cycle) {
                return cycle.tokens.length > 0 || cycle.phrase;
            });
            if (!cycles.length) return list;

            var map = new Map();
            cycles.forEach(function(cycle) {
                list.forEach(function(asset) {
                    var score = scoreAsset(asset, cycle);
                    if (score < cycle.minScore) return;
                    var existing = map.get(asset.id);
                    if (!existing || score > existing.score) {
                        map.set(asset.id, { asset: asset, score: score, cycle: cycle.name });
                    }
                });
            });

            var strictCycle = cycles[0];
            return Array.from(map.values())
                .map(function(entry) {
                    var recheck = scoreAsset(entry.asset, strictCycle);
                    return { asset: entry.asset, score: entry.score + Math.floor(recheck * 0.5) };
                })
                .sort(function(a, b) { return b.score - a.score; })
                .map(function(entry) { return entry.asset; });
        }

        /* --- Init --- */
        function init() {
            fetch('assets.json')
                .then(function(res) {
                    if (!res.ok) throw new Error('Failed to load assets');
                    return res.json();
                })
                .then(function(data) {
                    assets = data;
                    renderFilters();
                    renderAssets();
                    bindEvents();
                })
                .catch(function(err) {
                    console.error(err);
                    document.getElementById('assetGrid').innerHTML =
                        '<div class="library-empty"><div class="library-empty__title" style="color: var(--accent-red)">Failed to load assets. Please refresh.</div></div>';
                });
        }

        /* --- Render Filter Pills --- */
        function renderFilters() {
            var container = document.getElementById('filterPills');
            var counts = { all: assets.length };

            assets.forEach(function(a) {
                counts[a.category] = (counts[a.category] || 0) + 1;
            });

            var html = '';
            Object.keys(CATEGORIES).forEach(function(key) {
                if (key !== 'all' && !counts[key]) return;
                var isActive = key === activeCategory;
                var count = counts[key] || 0;
                html += '<button class="filter-pill' + (isActive ? ' active' : '') + '" data-category="' + key + '">';
                html += CATEGORIES[key];
                html += '<span class="filter-pill__count">(' + count + ')</span>';
                html += '</button>';
            });

            container.innerHTML = html;

            container.querySelectorAll('.filter-pill').forEach(function(pill) {
                pill.addEventListener('click', function() {
                    activeCategory = this.dataset.category;
                    container.querySelectorAll('.filter-pill').forEach(function(p) { p.classList.remove('active'); });
                    this.classList.add('active');
                    renderAssets();
                });
            });
        }

        /* --- Render Assets --- */
        function renderAssets() {
            var filtered = assets.filter(function(a) {
                var matchCat = activeCategory === 'all' || a.category === activeCategory;
                return matchCat;
            });

            if (searchQuery) {
                filtered = rankAssetsByQuery(filtered, searchQuery);
            }

            // Sort
            filtered.sort(function(a, b) {
                if (sortBy === 'popular') return b.usageCount - a.usageCount;
                if (sortBy === 'alpha') return a.title.localeCompare(b.title);
                if (sortBy === 'recent') return b.lastUpdated.localeCompare(a.lastUpdated);
                return 0;
            });

            var grid = document.getElementById('assetGrid');
            var empty = document.getElementById('emptyState');
            var info = document.getElementById('resultsInfo');

            info.textContent = filtered.length + ' asset' + (filtered.length !== 1 ? 's' : '') +
                (activeCategory !== 'all' ? ' in ' + CATEGORIES[activeCategory] : '') +
                (searchQuery ? ' matching "' + searchQuery + '"' : '');

            if (filtered.length === 0) {
                grid.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            grid.style.display = '';
            empty.style.display = 'none';

            var html = '';
            filtered.forEach(function(asset) {
                html += '<div class="asset-card" data-id="' + asset.id + '">';

                // Top: category badge + usage
                html += '<div class="asset-card__top">';
                html += '<span class="asset-card__category asset-card__category--' + asset.category + '">' + CATEGORIES[asset.category] + '</span>';
                html += '<span class="asset-card__usage">';
                html += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>';
                html += asset.usageCount + ' uses';
                html += '</span>';
                html += '</div>';

                // Title + desc
                html += '<div class="asset-card__title">' + escapeHtml(asset.title) + '</div>';
                html += '<div class="asset-card__desc">' + escapeHtml(asset.description) + '</div>';

                // Meta
                html += '<div class="asset-card__meta">';
                if (asset.stageLabel) {
                    html += '<span class="asset-card__stage">';
                    html += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>';
                    html += escapeHtml(asset.stageLabel);
                    html += '</span>';
                } else {
                    html += '<span>General</span>';
                }
                html += '<span>' + asset.lastUpdated + '</span>';
                html += '</div>';

                html += '</div>';
            });

            grid.innerHTML = html;

            // Card click handlers
            grid.querySelectorAll('.asset-card').forEach(function(card) {
                card.addEventListener('click', function() {
                    var id = this.dataset.id;
                    var asset = assets.find(function(a) { return a.id === id; });
                    if (asset) openModal(asset);
                });
            });
        }

        /* --- Modal --- */
        function openModal(asset) {
            currentAsset = asset;
            document.getElementById('modalTitle').textContent = asset.title;
            document.getElementById('modalContent').innerHTML = markdownToHtml(asset.content);
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
            currentAsset = null;
        }

        /* --- Simple Markdown to HTML --- */
        function markdownToHtml(md) {
            var html = md;
            // Headers
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            // Bold
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Tables
            html = html.replace(/\|(.+)\|\n\|[-| ]+\|\n((?:\|.+\|\n?)*)/g, function(match, header, body) {
                var ths = header.split('|').map(function(h) { return '<th>' + h.trim() + '</th>'; }).join('');
                var rows = body.trim().split('\n').map(function(row) {
                    var tds = row.replace(/^\||\|$/g, '').split('|').map(function(d) { return '<td>' + d.trim() + '</td>'; }).join('');
                    return '<tr>' + tds + '</tr>';
                }).join('');
                return '<table><thead><tr>' + ths + '</tr></thead><tbody>' + rows + '</tbody></table>';
            });
            // Lists
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            // Paragraphs (lines not inside tags)
            html = html.split('\n').map(function(line) {
                line = line.trim();
                if (!line) return '';
                if (line.match(/^<(h[23]|ul|ol|li|table|thead|tbody|tr|th|td|div|p)/)) return line;
                return '<p>' + line + '</p>';
            }).join('\n');
            // Clean up double-wrapped
            html = html.replace(/<p><\/p>/g, '');

            return html;
        }

        /* --- Bind Events --- */
        function bindEvents() {
            // Search
            var searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                clearTimeout(searchDebounceTimer);
                var val = sanitizeSearchInput(this.value).toLowerCase();
                searchDebounceTimer = setTimeout(function() {
                    searchQuery = val;
                    renderAssets();
                }, 180);
            });

            // Sort
            document.getElementById('sortSelect').addEventListener('change', function() {
                sortBy = this.value;
                renderAssets();
            });

            // Modal close
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('modalOverlay').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });

            // Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });

            // Copy
            document.getElementById('modalCopy').addEventListener('click', function() {
                if (!currentAsset) return;
                if (window.ExportUtils) {
                    ExportUtils.copyToClipboard(currentAsset.content, this);
                } else {
                    navigator.clipboard.writeText(currentAsset.content).then(function() {
                        showButtonFeedback(document.getElementById('modalCopy'), 'Copied');
                    });
                }
            });

            // Print
            document.getElementById('modalPrint').addEventListener('click', function() {
                if (!currentAsset) return;
                if (window.ExportUtils) {
                    ExportUtils.printContent(currentAsset.title, document.getElementById('modalContent').innerHTML);
                } else {
                    var w = window.open('', '_blank');
                    w.document.write('<html><head><title>' + currentAsset.title + '</title></head><body>' +
                        document.getElementById('modalContent').innerHTML + '</body></html>');
                    w.document.close();
                    w.print();
                }
            });

            // Download
            document.getElementById('modalDownload').addEventListener('click', function() {
                if (!currentAsset) return;
                var filename = currentAsset.id + '.md';
                if (window.ExportUtils) {
                    ExportUtils.downloadFile(filename, currentAsset.content, 'text/markdown');
                } else {
                    var blob = new Blob([currentAsset.content], { type: 'text/markdown' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });
        }

        function showButtonFeedback(btn, msg) {
            var orig = btn.innerHTML;
            btn.textContent = msg;
            setTimeout(function() { btn.innerHTML = orig; }, 1500);
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        /* --- Init --- */
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>
</body>
</html>
